<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°æ˜¥UNLOCK</title>
    
    <!-- Google Analytics (Placeholder) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZT8CBC1JLV"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZT8CBC1JLV');
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-red: #ef4444;
            --color-white: #ffffff;
            --color-gold: #d4af37;
        }
        body {
            font-family: "Zen Maru Gothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #fdf2f0;
            color: #334155;
            touch-action: manipulation; user-select: none; overflow-x: hidden;
        }
        h1, h2, h3, .font-serif {
            font-family: "Yuji Syuku", serif;
        }
        
        .bg-pattern-seigaiha {
            background-color: #fdf2f0;
            background-image: 
                radial-gradient(circle at 100% 150%, #fdf2f0 24%, #fee2e2 25%, #fee2e2 28%, #fdf2f0 29%, #fdf2f0 36%, #fee2e2 37%, #fee2e2 40%, transparent 40%, transparent),
                radial-gradient(circle at 0    150%, #fdf2f0 24%, #fee2e2 25%, #fee2e2 28%, #fdf2f0 29%, #fdf2f0 36%, #fee2e2 37%, #fee2e2 40%, transparent 40%, transparent),
                radial-gradient(circle at 50%  100%, #fee2e2 10%, #fdf2f0 11%, #fdf2f0 23%, #fee2e2 24%, #fee2e2 30%, #fdf2f0 31%, #fdf2f0 43%, #fee2e2 44%, #fee2e2 50%, #fdf2f0 51%, #fdf2f0 63%, #fee2e2 64%, #fee2e2 71%, transparent 71%, transparent),
                radial-gradient(circle at 100% 50%, #fee2e2 5%, #fdf2f0 6%, #fdf2f0 15%, #fee2e2 16%, #fee2e2 20%, #fdf2f0 21%, #fdf2f0 30%, #fee2e2 31%, #fee2e2 35%, #fdf2f0 36%, #fdf2f0 45%, #fee2e2 46%, #fee2e2 49%, transparent 50%, transparent),
                radial-gradient(circle at 0    50%, #fee2e2 5%, #fdf2f0 6%, #fdf2f0 15%, #fee2e2 16%, #fee2e2 20%, #fdf2f0 21%, #fdf2f0 30%, #fee2e2 31%, #fee2e2 35%, #fdf2f0 36%, #fdf2f0 45%, #fee2e2 46%, #fee2e2 49%, transparent 50%, transparent);
            background-size: 60px 30px;
        }

        /* Animations */
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .animate-bounce-gentle { animation: bounce-gentle 3s ease-in-out infinite; }
        
        @keyframes pop-in { 0% { transform: scale(0.9); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 10s linear infinite; }
        
        @keyframes confuse-shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .animate-confuse { animation: confuse-shake 0.2s infinite; }

        /* UI Components */
        .btn-newyear {
            position: relative;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 4px 0 #b91c1c, 0 8px 10px rgba(0,0,0,0.2);
            transition: all 0.1s;
            overflow: hidden;
        }
        .btn-newyear::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
            background-size: 200% 200%;
            animation: shine 3s infinite linear;
            pointer-events: none;
        }
        .btn-newyear:active { transform: translateY(4px); box-shadow: 0 0 0 #b91c1c, inset 0 2px 5px rgba(0,0,0,0.2); }
        
        .card-washi {
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.05);
        }

        /* Level Buttons */
        .level-btn { transition: all 0.2s; position: relative; overflow: hidden; }
        .level-btn.selected { transform: scale(1.02); border-width: 2px; }
        .level-btn:not(.selected) { opacity: 0.7; transform: scale(0.98); filter: grayscale(0.5); }
        
        .level-ume { background: #fee2e2; border-color: #f87171; color: #b91c1c; }
        .level-take { background: #dcfce7; border-color: #4ade80; color: #15803d; }
        .level-matsu { background: #dbeafe; border-color: #60a5fa; color: #1d4ed8; }
        .level-fuji { 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); 
            border-color: #fbbf24; color: #b45309; 
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .mizuhiki-line {
            height: 4px; width: 100%;
            background: repeating-linear-gradient(90deg, #ef4444, #ef4444 10px, #ffffff 10px, #ffffff 20px, #d4af37 20px, #d4af37 30px);
        }
        
        .menu-item {
            background: white; border-radius: 16px; 
            border: 2px solid #fee2e2;
            box-shadow: 0 4px 0 #fecaca;
            transition: all 0.1s;
        }
        .menu-item:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }

        .writing-vertical-box {
            writing-mode: vertical-rl;
            text-orientation: upright;
            white-space: nowrap;
            letter-spacing: 0.15em;
        }
        /* Mobile height fix */
        .h-dvh { height: 100vh; height: 100dvh; }
    </style>
</head>
<body class="h-dvh w-full flex flex-col items-center justify-center relative text-slate-700 bg-pattern-seigaiha overflow-hidden">

    <!-- Japanese New Year Decorations -->
    <div class="absolute top-0 left-0 w-32 h-32 opacity-20 pointer-events-none">
        <svg viewBox="0 0 100 100" fill="#fca5a5"><path d="M50 50m-20 0a20 20 0 1 0 40 0a20 20 0 1 0 -40 0 M50 20a20 20 0 1 0 0 40a20 20 0 1 0 0 -40 M80 50a20 20 0 1 0 -40 0a20 20 0 1 0 40 0 M50 80a20 20 0 1 0 0 -40a20 20 0 1 0 0 40 M20 50a20 20 0 1 0 40 0a20 20 0 1 0 -40 0" /></svg>
    </div>
    <div class="absolute bottom-0 right-0 w-40 h-40 opacity-20 pointer-events-none">
        <svg viewBox="0 0 100 100" fill="#86efac"><path d="M50 10 L80 40 L65 40 L90 70 L10 70 L35 40 L20 40 Z" /></svg>
    </div>

    <!-- Main Container -->
    <div id="app" class="w-full max-w-md h-full flex flex-col relative px-5 py-4 z-10 overflow-y-auto no-scrollbar supports-scrollbars:pr-2">
        
        <!-- Header -->
        <header id="app-header" class="hidden justify-center items-center mb-2 animate-pop pt-1 shrink-0">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.switchView('menu')">
                <div class="w-7 h-7 bg-red-500 text-white rounded-full flex items-center justify-center font-serif font-bold text-[10px] border-2 border-white shadow-sm">ç¦</div>
                <span class="text-lg font-bold tracking-tight text-slate-800 font-serif">æ–°æ˜¥UNLOCK</span>
            </div>
        </header>

        <!-- [VIEW: LANGUAGE (NENGAJO)] -->
        <div id="view-language" class="flex flex-1 flex-col justify-center items-center animate-pop min-h-[450px]">
            
            <!-- Nengajo Card -->
            <div class="bg-white w-full max-w-sm aspect-[100/148] shadow-2xl rounded-sm p-6 relative flex flex-col overflow-hidden border border-slate-200 transform rotate-1 transition-transform hover:rotate-0 duration-500">
                
                <!-- Stamps -->
                <div class="absolute top-5 left-5 w-12 h-14 border border-red-300 rounded flex items-center justify-center opacity-60">
                    <div class="text-xs text-red-400 font-serif font-bold text-center leading-none writing-vertical-box" style="letter-spacing:0;">å¹´è³€</div>
                </div>
                <div class="absolute top-4 right-4 opacity-30">
                    <div class="w-16 h-16 rounded-full border-2 border-red-500 flex items-center justify-center rotate-12">
                        <span class="text-xs font-bold text-red-500 text-center leading-tight">2026<br>å…ƒæ—¦</span>
                    </div>
                </div>

                <!-- Main Content Layout -->
                <div class="flex flex-row h-full mt-12 mb-4 items-center">
                    
                    <!-- Vertical Text -->
                    <div class="flex-none flex justify-center items-start pr-6 border-r border-dashed border-red-100 mr-6 h-48">
                        <h1 class="text-5xl font-black text-red-600 font-serif writing-vertical-box leading-relaxed tracking-widest drop-shadow-sm h-full flex items-center">
                            è¬¹è³€æ–°å¹´
                        </h1>
                    </div>

                    <!-- Greeting & Icon -->
                    <div class="flex-1 flex flex-col justify-center items-center text-center">
                        <div class="mb-4 relative">
                            <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center animate-bounce-gentle border border-red-100">
                                <i class="fa-solid fa-dragon text-red-500 text-3xl"></i>
                            </div>
                            <div class="absolute -right-1 -top-1 text-yellow-500 animate-spin-slow text-lg"><i class="fa-solid fa-sun"></i></div>
                        </div>
                        <p class="text-xs font-serif text-slate-600 leading-6 tracking-wider mb-2">
                            æ—§å¹´ä¸­ã¯è„³ã‚’<br>ã”æ„›ç”¨ã„ãŸã ã<br>
                            èª ã«ã‚ã‚ŠãŒã¨ã†<br>ã”ã–ã„ã¾ã—ãŸ<br>
                            æœ¬å¹´ã‚‚ä½•å’ã‚ˆã‚ã—ã<br>
                            ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™
                        </p>
                    </div>
                </div>

                <!-- Buttons area at bottom -->
                <div class="w-full flex flex-col gap-2 mt-auto pt-4 border-t border-slate-100">
                    <button onclick="app.setLanguage('ja')" class="w-full bg-red-600 text-white font-serif font-bold py-3 rounded shadow-md border-b-4 border-red-800 active:translate-y-1 active:border-b-0 active:bg-red-700 transition-all flex items-center justify-center gap-2">
                        <span class="tracking-widest text-base">æ—¥æœ¬èªã§å§‹ã‚ã‚‹</span>
                    </button>
                    <button onclick="app.setLanguage('en')" class="w-full text-slate-400 font-serif font-bold py-1 text-[10px] hover:text-slate-500 transition-colors">
                        English Mode
                    </button>
                </div>

                <!-- Texture Overlay -->
                <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiIG9wYWNpdHk9IjAuMSIvPgo8L3N2Zz4=')] opacity-30 pointer-events-none"></div>
            </div>
            
            <p class="mt-4 text-[10px] text-red-900/50 font-serif font-bold tracking-widest">å…ƒæ—¦ @ UNLOCK</p>
        </div>

        <!-- [VIEW: MENU] -->
        <div id="view-menu" class="hidden flex-1 flex-col justify-center items-center animate-pop w-full">
            <h2 class="text-2xl font-black text-red-900 mb-6 font-serif text-center drop-shadow-sm" data-i18n="menu_title">ãŠå“æ›¸ã</h2>
            
            <div class="grid grid-cols-2 gap-3 w-full mb-4 max-w-[340px]">
                <!-- 1. Math -->
                <button onclick="app.selectGame('math_reflex')" class="menu-item p-3 flex flex-col items-center justify-center aspect-[4/3] active:scale-95">
                    <div class="relative mb-2"><i class="fa-solid fa-abacus text-green-500 text-3xl"></i><i class="fa-solid fa-dice-five absolute -top-1 -right-2 text-green-300 text-sm"></i></div>
                    <span class="font-bold text-xs text-slate-700 font-serif" data-i18n="game_type_math_reflex">ä¸åŠ è¨ˆç®—</span>
                </button>
                <!-- 2. Memory -->
                <button onclick="app.selectGame('memory_flash')" class="menu-item p-3 flex flex-col items-center justify-center aspect-[4/3] active:scale-95">
                    <i class="fa-solid fa-eye text-purple-500 text-3xl mb-2"></i>
                    <span class="font-bold text-xs text-slate-700 font-serif" data-i18n="game_type_memory_flash">åˆå¤¢ãŠã¼ãˆ</span>
                </button>
                <!-- 3. Karuta -->
                <button onclick="app.selectGame('karuta')" class="menu-item p-3 flex flex-col items-center justify-center aspect-[4/3] active:scale-95">
                    <i class="fa-solid fa-layer-group text-orange-500 text-3xl mb-2"></i>
                    <span class="font-bold text-xs text-slate-700 font-serif" data-i18n="game_type_karuta">æ–°æ˜¥ ã‹ã‚‹ãŸ</span>
                </button>
                <!-- 4. HighLow -->
                <button onclick="app.selectGame('high_low')" class="menu-item p-3 flex flex-col items-center justify-center aspect-[4/3] active:scale-95">
                    <i class="fa-solid fa-sack-dollar text-yellow-500 text-3xl mb-2"></i>
                    <span class="font-bold text-xs text-slate-700 font-serif" data-i18n="game_type_high_low">ãŠå¹´ç‰ãƒã‚¤ãƒ­ãƒ¼</span>
                </button>
            </div>
            <p class="text-xs text-red-900/60 mt-1">â€»ä½•åº¦ã§ã‚‚éŠã¹ã¾ã™</p>
        </div>

        <!-- [VIEW: LP] -->
        <div id="view-lp" class="hidden flex-1 flex-col justify-center items-center animate-pop relative pb-6">
            <div class="text-center mb-6">
                <div class="mb-4 inline-block relative">
                    <div class="flex justify-center items-center relative h-32 w-32 mx-auto animate-bounce-gentle">
                        <div class="absolute inset-0 border-4 border-red-500 rounded-full opacity-20 bg-white/50"></div>
                        <div class="absolute inset-2 border-2 border-gold rounded-full opacity-40 border-dashed"></div>
                        <div class="absolute w-20 h-20 bg-white rounded-full shadow-lg z-20 flex items-center justify-center border-2 border-red-100">
                            <i id="lp-game-icon" class="fa-solid fa-dragon text-red-500 text-4xl"></i>
                        </div>
                        <i class="fa-regular fa-snowflake absolute top-0 right-0 text-white/50 text-2xl animate-spin-slow"></i>
                        <i class="fa-solid fa-fan absolute bottom-0 left-0 text-gold text-2xl"></i>
                    </div>
                </div>
                
                <div class="bg-white border-2 border-red-100 rounded-xl px-6 py-3 mt-4 mb-2 inline-block shadow-sm relative overflow-hidden max-w-[280px]">
                    <div class="mizuhiki-line absolute top-0 left-0 opacity-50"></div>
                    <p class="text-xs font-bold text-red-400 mb-1 tracking-widest">SELECTED GAME</p>
                    <p class="text-xl font-black text-slate-700 font-serif" id="lp-game-title">...</p>
                </div>
                <p id="lp-game-desc" class="text-red-900/80 font-medium text-xs px-4 mt-2 leading-relaxed max-w-[300px] text-center">...</p>
            </div>
            
            <button onclick="app.toDifficulty()" class="w-full max-w-[280px] btn-newyear font-bold text-xl py-5 shadow-lg shadow-red-900/50 group mb-3">
                <i class="fa-solid fa-play text-yellow-300 mr-2"></i> <span data-i18n="btn_start">ã“ã‚Œã«ã™ã‚‹</span>
            </button>
            <button onclick="app.switchView('menu')" class="text-red-900/70 text-sm font-bold underline py-2">
                <span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span>
            </button>
        </div>

        <!-- [VIEW: DIFFICULTY] -->
        <div id="view-difficulty" class="hidden flex-1 flex-col justify-center items-center animate-pop">
            <h2 class="text-2xl font-black text-red-900 mb-2 font-serif drop-shadow-sm" data-i18n="diff_title">é›£æ˜“åº¦ã‚’é¸ã¶</h2>
            <p class="text-xs text-red-900/80 mb-6" data-i18n="diff_desc">æ¾ç«¹æ¢…ã€ã©ã‚Œã«ã™ã‚‹ï¼Ÿ</p>
            
            <div class="w-full max-w-[280px] grid grid-cols-2 gap-3 mb-6">
                <button onclick="app.setDifficulty('easy')" id="btn-easy" class="level-btn level-ume rounded-xl p-3 flex flex-col items-center justify-center h-28 cursor-pointer shadow-sm">
                    <div class="text-2xl mb-2">ğŸŒ¸</div>
                    <span class="text-base font-bold font-serif" data-i18n="lvl_easy">æ¢… (åˆç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_easy_sub">ã®ã‚“ã³ã‚Šã¨</span>
                </button>
                <button onclick="app.setDifficulty('normal')" id="btn-normal" class="level-btn level-take selected rounded-xl p-3 flex flex-col items-center justify-center h-28 cursor-pointer shadow-sm">
                    <div class="text-2xl mb-2">ğŸ‹</div>
                    <span class="text-base font-bold font-serif" data-i18n="lvl_normal">ç«¹ (ä¸­ç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_normal_sub">ãã“ãã“ã«</span>
                </button>
                <button onclick="app.setDifficulty('pro')" id="btn-pro" class="level-btn level-matsu rounded-xl p-3 flex flex-col items-center justify-center h-28 cursor-pointer shadow-sm">
                    <div class="text-2xl mb-2">ğŸ</div>
                    <span class="text-base font-bold font-serif" data-i18n="lvl_pro">æ¾ (ä¸Šç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_pro_sub">ã‚­ãƒ¬ã‚­ãƒ¬ã§</span>
                </button>
                <button onclick="app.setDifficulty('olympic')" id="btn-olympic" class="level-btn level-fuji rounded-xl p-3 flex flex-col items-center justify-center h-28 cursor-pointer shadow-sm">
                    <div class="text-2xl mb-2">ğŸ—»</div>
                    <span class="text-base font-bold font-serif" data-i18n="lvl_olympic">å¯Œå£« (é¬¼)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_olympic_sub">ç„¡ç†ã‚²ãƒ¼</span>
                </button>
            </div>
            <button onclick="app.enterHome()" class="w-full max-w-[280px] bg-slate-800 text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-transform">æ±ºå®š</button>
            <button onclick="app.switchView('menu')" class="mt-4 text-red-900/70 text-sm font-bold underline py-2"><span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span></button>
        </div>

        <!-- [VIEW: HOME] -->
        <div id="view-home" class="hidden flex-1 flex-col justify-center items-center animate-pop">
            <div class="text-center mb-4">
                <h2 class="text-2xl font-black text-red-900 font-serif drop-shadow-sm" data-i18n="home_title">ä»Šæ—¥ã®æ›¸åˆã‚</h2>
                <div id="level-badge" class="inline-block bg-white text-red-500 text-[10px] font-bold px-3 py-1 rounded-full mt-1 shadow-sm border border-red-100">LEVEL</div>
            </div>

            <div class="card-washi w-full max-w-[300px] p-6 mb-6 relative overflow-hidden">
                <div class="relative z-10 text-center">
                    <span class="inline-block bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded mb-3">TODAY'S MISSION</span>
                    <h3 id="daily-title" class="text-2xl font-black mb-2 text-slate-800 font-serif">Title</h3>
                    <p id="daily-desc" class="text-sm font-medium text-slate-600 mb-4 leading-relaxed">...</p>
                    <div class="flex justify-center gap-2">
                        <div class="bg-slate-50 px-3 py-1 rounded-full text-[10px] font-bold text-slate-500 border border-slate-200"><i class="fa-regular fa-clock mr-1"></i> 30ç§’ä¸€æœ¬å‹è² </div>
                    </div>
                </div>
            </div>

            <button onclick="app.startGame()" class="w-full max-w-[300px] btn-newyear text-xl py-5 shadow-lg shadow-red-900/50">
                <span data-i18n="btn_game_start">ã„ã–ã€å‹è² ï¼</span>
            </button>
            <button onclick="app.switchView('difficulty')" class="mt-6 text-red-900/70 text-xs font-bold underline py-2" data-i18n="btn_change_lvl">é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹</button>
        </div>

        <!-- [VIEW: GAME] -->
        <div id="view-game" class="hidden flex-1 flex-col relative h-full w-full">
            <div class="w-full bg-white/40 rounded-full h-2 mb-2 overflow-hidden mt-2 shrink-0 border border-white/20">
                <div id="timer-bar" class="bg-white h-full rounded-full transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(255,255,255,0.8)]" style="width: 100%"></div>
            </div>

            <div class="flex justify-between items-end mb-2 px-2 border-b-2 border-white/30 pb-2 text-white shrink-0">
                <div class="flex flex-col">
                     <span class="text-[10px] font-bold opacity-90 drop-shadow-sm" id="game-level-badge">LEVEL</span>
                     <div class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded-full border border-white/40 backdrop-blur-sm">å¾—ç‚¹</div>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="score-display" class="text-4xl font-black font-serif drop-shadow-md">0</span>
                    <span class="text-xs font-bold opacity-90">ç‚¹</span>
                </div>
            </div>

            <div id="game-stage" class="flex-1 card-washi flex flex-col p-3 mb-2 relative transition-colors duration-300 items-center justify-center min-h-0">
                <div id="instruction-overlay" class="absolute inset-0 bg-white/95 z-30 flex flex-col justify-center items-center text-center p-6 rounded-2xl">
                    <div class="text-5xl text-red-500 mb-4 animate-bounce"><i class="fa-solid fa-clover"></i></div>
                    <h3 class="text-2xl font-bold mb-2 text-slate-800 font-serif" data-i18n="overlay_rule">ãƒ«ãƒ¼ãƒ«</h3>
                    <p id="game-rule-text" class="font-medium text-slate-600 mb-4 text-base">...</p>
                    <div class="text-4xl font-black text-red-500 animate-pulse font-serif">ã‚ˆãƒ¼ã„...</div>
                </div>
                <div id="stimulus-container" class="w-full h-full flex flex-col relative items-center justify-center"></div>
            </div>
            <div id="controls-area" class="grid grid-cols-2 gap-2 h-40 mb-2 shrink-0"></div>
        </div>

        <!-- [VIEW: RESULT (BRAIN DIAGNOSIS)] -->
        <div id="view-result" class="hidden flex-1 flex-col justify-center items-center animate-pop w-full pb-4">
            
            <div class="text-center mb-3 mt-1">
                <h2 class="text-4xl font-black text-red-600 font-serif drop-shadow-md tracking-wider" data-i18n="res_title">UNLOCKå®Œäº†ï¼</h2>
                <p class="text-xs font-bold text-red-900/80 mt-1">ä»Šå¹´ã®ä¸»å½¹è„³ã¯â€¦ï¼Ÿ</p>
            </div>

            <div class="card-washi w-full max-w-[340px] py-6 px-5 text-center mb-4 bg-white relative border-4 border-double border-red-100 flex flex-col items-center">
                
                <!-- Diagnosis Content -->
                <div id="brain-result-area" class="w-full text-left">
                    <!-- Dynamic Content -->
                </div>

                <div class="w-full h-px bg-slate-100 my-4"></div>

                <div class="flex items-end justify-center gap-2 mb-1">
                    <div class="text-xs font-bold text-slate-400 mb-1">SCORE</div>
                    <div id="final-score" class="text-5xl font-black text-slate-800 font-serif leading-none">0</div>
                </div>
            </div>

            <!-- LINE CTA Button -->
            <a href="https://line.me/" target="_blank" class="w-full max-w-[300px] bg-[#06C755] text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform mb-3 relative overflow-hidden group border border-green-400">
                <i class="fa-brands fa-line text-xl absolute left-4"></i>
                <span class="text-sm">å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ </span>
                <i class="fa-solid fa-chevron-right absolute right-4 opacity-50 text-xs"></i>
            </a>

            <div class="flex w-full max-w-[300px] gap-2 mb-3">
                <button onclick="app.share('twitter')" class="flex-1 bg-black text-white font-bold py-2.5 rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform text-xs"><i class="fa-brands fa-x-twitter"></i> Xã§ã‚·ã‚§ã‚¢</button>
                <button onclick="app.enterHome()" class="flex-1 bg-slate-200 text-slate-600 font-bold py-2.5 rounded-lg shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform text-xs">ã‚‚ã†ä¸€åº¦</button>
            </div>
            
            <button onclick="app.switchView('menu')" class="text-red-900/70 text-xs font-bold underline p-2 mb-2"><span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span></button>
        </div>

        <!-- [VIEW: LOADING] -->
        <div id="view-loading" class="hidden flex-1 flex-col justify-center items-center">
            <div class="flex gap-2 mb-3">
                <div class="w-3 h-3 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-3 h-3 bg-white border-2 border-slate-200 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-3 h-3 bg-gold rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <p class="text-[10px] font-bold text-white tracking-widest">LOADING...</p>
        </div>
    </div>

    <!-- SCRIPT -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const AppConfig = { gameDuration: 30, storageBaseKey: 'newyear_unlock_v18_' };
        
        // --- DATA: Brain Diagnosis ---
        const BrainData = [
            { 
                name: "å‰é ­å‰é‡", 
                kana: "ãœã‚“ã¨ã†ãœã‚“ã‚„", 
                role: "è„³ã®ç¤¾é•·å®¤ã€‚æ±ºã‚ã‚‹ã€æ­¢ã‚ã‚‹ã€é¸ã¶ã€æ®µå–ã‚Šã™ã‚‹ã€‚ã€Œã‚„ã‚‹æ°—ã€ã˜ã‚ƒãªãã¦ã€Œã‚„ã‚‹é †ç•ªã€ã‚’ä½œã‚‹ã¨ã“ã‚ã€‚<br>ã“ã“ãŒå…ƒæ°—ã ã¨ã€äººç”ŸãŒã‚¹ãƒƒã‚­ãƒªè¦‹ãˆã‚‹ã—ã€ã“ã“ãŒç–²ã‚Œã¦ã‚‹ã¨ã€å†·è”µåº«ã®å‰ã§ãšã£ã¨æ‚©ã‚€ï¼ˆä½•é£Ÿã¹ã‚‹ã‹ã§30åˆ†ã­ï¼‰ã€‚",
                unlock: "æœã„ã¡ã§ã€Œä»Šæ—¥ã‚„ã‚‹1å€‹ã€ã‚’æ±ºã‚ã¦ã€ç´™ã«æ›¸ãã€‚ã§ã€æœ€åˆã®1åˆ†ã ã‘ç€æ‰‹ã€‚ç¤¾é•·ã¯é•·ã„ä¼šè­°ã„ã‚‰ãªã„ã®ã€‚â€œæŒ‡ç¤ºâ€ãŒå‡ºãŸç¬é–“ã«ç¾å ´ï¼ˆä»–ã®è„³ï¼‰ãŒåƒãã‹ã‚‰ã€‚è¿·ã£ãŸã‚‰ã€Œ10åˆ†ã ã‘ã‚„ã‚‹ã€ã§OKã€‚æ±ºæ–­ã¯çŸ­ã„ã»ã©å¼·ã„ã€‚",
                word: "ã€Œç¤¾é•·ã¯1å€‹ã ã‘è¨€ãˆã°ã„ã„ã®ã‚ˆã€‚ã€"
            },
            { 
                name: "èƒŒå¤–å´å‰é ­å‰é‡", 
                kana: "DLPFC", 
                role: "è„³ã®ä½œæ¥­æœºã€‚é›†ä¸­ã—ã¦è€ƒãˆã‚‹ã€æƒ…å ±ã‚’ä¸€æ™‚çš„ã«æŒã¤ã€è«–ç†ã§çµ„ã¿ç«‹ã¦ã‚‹ã€‚<br>ã“ã“ãŒå¼·ã„ã¨â€œé ­ã®ä¸­ã®ä»˜ç®‹â€ãŒãã‚Œã„ã«è²¼ã‚Œã¦ã‚‹æ„Ÿã˜ã€‚å¼±ã‚‹ã¨ä»˜ç®‹ãŒåºŠã«æ•£ã‚‰ã°ã£ã¦ã€è¸ã‚“ã§æ»‘ã‚‹ã€‚",
                unlock: "25åˆ†é›†ä¸­â†’3åˆ†å‹•ãã€‚æœºä»•äº‹ã®ã¾ã¾è„³ã‚’å›ãã†ã¨ã™ã‚‹ã¨ã€æœºã¨åŒåŒ–ã—ã¦æ€è€ƒãŒå›ºã¾ã‚‹ã®ã‚ˆã€‚çŸ­ã„é›†ä¸­ã‚’ç¹°ã‚Šè¿”ã™ã¨ã€æœºãŒç‰‡ä»˜ã„ã¦ã„ãæ„Ÿã˜ã«ãªã‚‹ã€‚ã‚¹ãƒãƒ›ã¯åˆ¥å®¤ã€‚DLPFCã¯èª˜æƒ‘ã«å¼±ã„ã‹ã‚‰ã€éš”é›¢ãŒå„ªã—ã•ã€‚",
                word: "ã€Œæœºã€è©°ã‚ã‚‹ãªã€‚åŒºåˆ‡ã‚Œã€‚ã€"
            },
            { 
                name: "çœ¼çª©å‰é ­çš®è³ª", 
                kana: "OFC", 
                role: "è„³ã®è²·ã„ç‰©æ‹…å½“ã€‚ã€ŒAã¨Bã©ã£ã¡ãŒå¾—ï¼Ÿã€ã‚’æ¯”ã¹ã¦ã€æ°—åˆ†ã¨ä¾¡å€¤ã§é¸ã¶ã¨ã“ã‚ã€‚<br>ã“ã“ãŒåƒãã¨ã€é¸ã¶ã®ãŒä¸Šæ‰‹ã„ã€‚æ­¢ã¾ã‚‹ã¨ã€é€šè²©ã®ã‚«ãƒ¼ãƒˆã«å…¥ã‚ŒãŸã¾ã¾æ°¸é ã«æ‚©ã‚€ã€‚",
                unlock: "è¿·ã£ãŸã‚‰â€œè©¦é£Ÿâ€ã™ã‚‹ã€‚10åˆ†ã ã‘ã‚„ã‚‹ã€1å›ã ã‘ä½¿ã†ã€çŸ­ãä½“é¨“ã™ã‚‹ã€‚è„³ã¯ã‚«ã‚¿ãƒ­ã‚°ã‚ˆã‚Šå®Ÿç‰©ã§æ±ºã‚ã‚‹ã‹ã‚‰ã€‚æ¯”è¼ƒã®æ²¼ã¯æ™‚é–“ã‚’é£Ÿã†ã ã‘ã€‚å°ã•ãè©¦ã™ã¨ã€OFCãŒã€Œã“ã£ã¡ï¼ã€ã£ã¦è¨€ã„å‡ºã™ã€‚",
                word: "ã€Œæ‚©ã‚€ãªã‚‰ã€è©¦ã—ã¡ã‚ƒã„ãªã‚ˆã€‚ã€"
            },
            { 
                name: "å‰éƒ¨å¸¯çŠ¶çš®è³ª", 
                kana: "ACC", 
                role: "è„³ã®ãƒ„ãƒƒã‚³ãƒŸå½¹ã€‚é–“é•ã„ã«æ°—ã¥ãã€åˆ‡ã‚Šæ›¿ãˆã‚‹ã€æ³¨æ„ã‚’æˆ»ã™ã€‚ã€Œã‚ã€ä»Šã‚ºãƒ¬ãŸã€ã‚’æ¤œçŸ¥ã—ã¦ãã‚Œã‚‹ã€‚<br>ã“ã“ãŒå…ƒæ°—ã ã¨ã€ãƒŸã‚¹ã—ã¦ã‚‚ç«‹ã¦ç›´ã—ãŒé€Ÿã„ã€‚ç–²ã‚Œã¦ã‚‹ã¨ã€ãƒŸã‚¹ã«æ°—ã¥ã‹ãšâ€œã¾ã£ã™ãè¿·å­â€ã«ãªã‚‹ã€‚",
                unlock: "ã‚ã–ã¨â€œã¡ã‚‡ã„ãƒ ã‚ºâ€ã‚’å…¥ã‚Œã‚‹ã€‚é€†æ‰‹ã€é€†è¶³ã€é€†é †ã€ãƒ†ãƒ³ãƒå¤‰ãˆã€‚ãƒŸã‚¹ã£ãŸç¬é–“ã«ACCãŒèµ·ãã‚‹ã®ã‚ˆã€‚ã€ŒãŠã£ã€ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿï¼ã€ã£ã¦ã€‚å®Œç’§ã«ã‚„ã‚‹ã‚ˆã‚Šã€ã‚ºãƒ¬ã‚’æ¥½ã—ã‚€æ–¹ãŒè„³ãŒè‚²ã¤ã€‚",
                word: "ã€ŒãƒŸã‚¹ã¯ã­ã€è„³ã®èµ·åºŠãƒœã‚¿ãƒ³ã€‚ã€"
            },
            { 
                name: "é‹å‹•é‡", 
                kana: "", 
                role: "ä½“ã‚’å‹•ã‹ã™å¸ä»¤å¡”ã€‚è€ƒãˆã¦ã‹ã‚‰å‹•ãã‚“ã˜ã‚ƒãªãã¦ã€å‹•ãã“ã¨ã§è€ƒãˆã‚‚å§‹ã¾ã‚‹ã€‚<br>ã“ã“ãŒå›ã‚‹ã¨ã€æ°—åˆ†ã‚‚ä¸ŠãŒã‚‹ã€‚å›ã‚‰ãªã„ã¨ã€è„³ãŒâ€œé ­ã ã‘ã®ä¼šè­°â€ã‚’ãšã£ã¨ã‚„ã£ã¦ç–²ã‚Œã‚‹ã€‚",
                unlock: "ã¾ãš1åˆ†ã€è¶³ã‚’å‹•ã‹ã™ã€‚æ—©æ­©ãã€è¶³è¸ã¿ã€éšæ®µã¡ã‚‡ã„ä¸Šã‚Šã€‚é‹å‹•é‡ã¯ã€Œã¡ã‚‡ã£ã¨ã§ã„ã„ã‹ã‚‰å‹•ã‘ã€æ´¾ã€‚ã‚„ã‚‹æ°—ã¯å¾Œã‹ã‚‰æ¥ã‚‹ã€‚å‹•ãã¨è¡€æµãŒä¸ŠãŒã£ã¦ã€ä»–ã®è„³ã‚‚ã€Œã˜ã‚ƒã‚ä¿ºã‚‚ã€ã£ã¦èµ·ãã‚‹ã€‚",
                word: "ã€Œè€ƒãˆã‚‹å‰ã«ã€è¶³ã„ã‘ã€‚ã€"
            },
            { 
                name: "ä½“æ€§æ„Ÿè¦šé‡", 
                kana: "", 
                role: "è§¦è¦šãƒ»ç—›ã¿ãƒ»ä½ç½®æ„Ÿè¦šã€‚ä½“ã®åœ°å›³ã‚¢ãƒ—ãƒªã€‚ã“ã“ãŒæ­£ç¢ºã ã¨ã€å§¿å‹¢ã‚„å‹•ããŒå®‰å®šã—ã¦ã€ç–²ã‚Œã«ãã„ã€‚<br>ã“ã“ãŒãƒœãƒ¤ã‘ã‚‹ã¨ã€è‚©ã“ã‚Šã‚‚å¢—ãˆã‚‹ã—ã€å‹•ãã‚‚é›‘ã«ãªã‚‹ã€‚",
                unlock: "ç›®ã‚’é–‰ã˜ã¦å·¦å³ã§é•ã†å‹•ãã€‚å³æ‰‹ã‚°ãƒ¼å·¦æ‰‹ãƒ‘ãƒ¼â†’å…¥ã‚Œæ›¿ãˆã€è¶³ã‚‚æ··ãœã‚‹ã€‚è„³ãŒã€Œåœ°å›³æãç›´ã™ãã€ã£ã¦å¼µã‚Šåˆ‡ã‚‹ã€‚è§¦ã£ã¦ã€æ„Ÿã˜ã¦ã€ã‚ºãƒ©ã™ã€‚æ„Ÿè¦šã‚’èµ·ã“ã™ã¨ã€ä½“ã®èª¿å­ãŒæ•´ã†ã€‚",
                word: "ã€Œä½“ã¯ã­ã€åœ°å›³ãŒå‘½ã€‚ã€"
            },
            { 
                name: "å°è„³", 
                kana: "", 
                role: "ãƒãƒ©ãƒ³ã‚¹ã€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€å¾®èª¿æ•´ã€‚â€œä¸Šæ‰‹ããªã‚‹â€æ‹…å½“ã®è¦ªæ–¹ã€‚ç¹°ã‚Šè¿”ã—ã§å‹æ‰‹ã«æ´—ç·´ã—ã¦ã„ãã€‚<br>ã“ã“ãŒè‚²ã¤ã¨ã€å‹•ããŒè»½ããªã‚‹ã—ã€å¤±æ•—ãŒæ¸›ã‚‹ã€‚",
                unlock: "ç‰‡è¶³ç«‹ã¡ï¼‹æ‰‹æ‹å­ã€ãƒœãƒ¼ãƒ«ã‚­ãƒ£ãƒƒãƒã€ãƒªã‚ºãƒ éŠã³ã€‚ãƒ•ãƒ©ã¤ãã»ã©å°è„³ãŒå–œã¶ã€‚ã€ŒãŠã€ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆç™ºè¦‹ï¼ã€ã£ã¦ã­ã€‚ã†ã¾ãã‚„ã‚‹ã‚ˆã‚Šã€æºã‚Œã‚’çµŒé¨“ã—ãŸã»ã†ãŒä¼¸ã³ã‚‹ã€‚",
                word: "ã€Œãƒ•ãƒ©ã¤ã„ãŸï¼Ÿä¼¸ã³ã—ã‚ã ã­ã€‚ã€"
            },
            { 
                name: "å¤§è„³åŸºåº•æ ¸", 
                kana: "", 
                role: "ç¿’æ…£ã®è‡ªå‹•é‹è»¢ã€‚ã‚¯ã‚»å·¥å ´ã€‚æ„å¿—ã‚ˆã‚Šå¼·ã„ã€‚ã“ã“ã«å…¥ã£ãŸè¡Œå‹•ã¯ã€å‹æ‰‹ã«å›ã‚‹ã€‚è‰¯ã„ã‚¯ã‚»ã‚‚æ‚ªã„ã‚¯ã‚»ã‚‚ã€ã„ã£ãŸã‚“å·¥å ´ãŒå›ã‚‹ã¨æ­¢ã¾ã‚‰ãªã„ã€‚",
                unlock: "ã€Œæ¯æ—¥30ç§’ã€ã ã‘å›ºå®šã™ã‚‹ã€‚æ™‚é–“ã‚ˆã‚Šâ€œåŒã˜ã‚¿ã‚¤ãƒŸãƒ³ã‚°â€ãŒå¤§äº‹ã€‚æ­¯ã¿ãŒãå‰ã€é¢¨å‘‚ã®å‰ã€å¯ã‚‹å‰ã€‚å·¥å ´ã¯ãƒ«ãƒ¼ãƒ«ãŒå¥½ãã ã‹ã‚‰ã€çŸ­ãã€åŒã˜å ´æ‰€ã€åŒã˜é †ç•ªã€‚ã“ã‚Œã§ç¿’æ…£ãŒç”Ÿã¾ã‚Œã‚‹ã€‚",
                word: "ã€Œç¿’æ…£ã¯æ°—åˆã„ã˜ã‚ƒãªã„ã€ä»•çµ„ã¿ã€‚ã€"
            },
            { 
                name: "æµ·é¦¬", 
                kana: "", 
                role: "è¨˜æ†¶ã®æ•´ç†æ•´é “ã€‚å­¦ã³ã‚’â€œè‡ªåˆ†ã®è©±â€ã«ã™ã‚‹ç·¨é›†è€…ã€‚ã“ã“ãŒåƒãã¨ã€çµŒé¨“ãŒè³‡ç”£ã«ãªã‚‹ã€‚åƒã‹ãªã„ã¨ã€å…¨éƒ¨ãŒæµã‚Œã¦ã„ã£ã¦ã€Œä½•ã—ã¦ãŸã£ã‘ï¼Ÿã€ã«ãªã‚‹ã€‚",
                unlock: "å¤œã«ã€Œä»Šæ—¥ã‚ˆã‹ã£ãŸ3ã¤ã€ã€‚çŸ­ãã¦ã„ã„ã€‚ã§ãã‚Œã°â€œãªãœè‰¯ã‹ã£ãŸâ€ã‚‚ä¸€è¨€ã€‚æµ·é¦¬ã¯ã‚¹ãƒˆãƒ¼ãƒªãƒ¼ãŒå¤§å¥½ç‰©ã€‚è‰¯ã„å‡ºæ¥äº‹ã‚’ä¿å­˜ã™ã‚‹ã¨ã€æ¬¡ã®æ—¥ã®æ°—åˆ†ãŒåº•ä¸Šã’ã•ã‚Œã‚‹ã€‚",
                word: "ã€Œæ€ã„å‡ºã¯ã€ä½œã‚‹ã‚“ã˜ã‚ƒãªãã¦ä¿å­˜ã€‚ã€"
            },
            { 
                name: "æ‰æ¡ƒä½“", 
                kana: "", 
                role: "æ„Ÿæƒ…ã®è­¦å ±æ©Ÿã€‚å±é™ºã‚‚ãƒ¯ã‚¯ãƒ¯ã‚¯ã‚‚ã€ã¾ãšã“ã“ãŒé³´ã‚‰ã™ã€‚é³´ã‚‹ã®ã¯æ‚ªã˜ã‚ƒãªã„ã€‚é³´ã‚‰ãªã„æ–¹ãŒå›°ã‚‹ã€‚å•é¡Œã¯â€œé³´ã‚Šã£ã±ãªã—â€ã­ã€‚",
                unlock: "ãƒ‰ã‚­ãƒƒã¨ã—ãŸã‚‰ã€åãæ¯ã‚’é•·ã3å›ã€‚æ‰æ¡ƒä½“ã«ã€Œäº†è§£ã€ã§ã‚‚ä»Šã¯å¤§ä¸ˆå¤«ã€ã£ã¦ä¼ãˆã‚‹ã€‚ä½“ã‚’å…ˆã«è½ã¡ç€ã‹ã›ã‚‹ã¨ã€æ„Ÿæƒ…ãŒå‘³æ–¹ã«ãªã‚‹ã€‚ä¸å®‰ã¯ç‡ƒæ–™ã€‚æ‰±ã„æ–¹ã§æ¨é€²åŠ›ã«å¤‰ã‚ã‚‹ã€‚",
                word: "ã€Œè­¦å ±ã¯æ­¢ã‚ã‚‹ãªã€ãªã ã‚ã‚ã€‚ã€"
            },
            { 
                name: "å³¶çš®è³ª", 
                kana: "Insula", 
                role: "ä½“å†…ã‚»ãƒ³ã‚µãƒ¼ã®å®Ÿæ³ä¸­ç¶™ã€‚ç–²ã‚Œã€å¿ƒæ‹ã€èƒƒã®æ„Ÿã˜ã€å‘¼å¸ã€‚ç›´æ„Ÿã®ææ–™ã‚’é›†ã‚ã¦ã‚‹å ´æ‰€ã€‚<br>ã“ã“ãŒé‹­ã„ã¨ã€ç„¡ç†ã™ã‚‹å‰ã«æ°—ã¥ã‘ã‚‹ã€‚éˆã„ã¨ã€é™ç•Œã¾ã§è¡Œã£ã¦ã‹ã‚‰å€’ã‚Œã‚‹ã€‚",
                unlock: "1æ—¥1å›ã€Œä½“ã©ã“å›ºã„ï¼Ÿã€ã‚’èãã€‚é¦–ï¼ŸèƒŒä¸­ï¼ŸãŠè…¹ï¼Ÿ ã§ã€30ç§’ã ã‘è§¦ã£ã¦ã‚†ã‚‹ã‚ã‚‹ã€‚ä½“ã®å£°ã¯å°ã•ã„ã‹ã‚‰ã€èãã«è¡Œãã€‚ã“ã“ãŒè‚²ã¤ã¨ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå®‰å®šã™ã‚‹ã€‚",
                word: "ã€Œä½“ã®å£°ã¯ã­ã€å°å£°ã ã‹ã‚‰èã‘ã€‚ã€"
            },
            { 
                name: "è¦–è¦šé‡", 
                kana: "å¾Œé ­è‘‰", 
                role: "è¦‹ã‚‹ã€è‰²ã€å½¢ã€å‹•ãã€‚è„³ã®ã‚«ãƒ¡ãƒ©ï¼†ç·¨é›†å®¤ã€‚ã“ã“ãŒå…ƒæ°—ã ã¨ã€ä¸–ç•ŒãŒé®®ã‚„ã‹ã«è¦‹ãˆã‚‹ã€‚ç–²ã‚Œã‚‹ã¨ã€è¦–ç•ŒãŒç°è‰²ã«ãªã£ã¦ã€æ°—åˆ†ã‚‚æ›‡ã‚‹ã€‚",
                unlock: "æ•£æ­©ã§ã€Œé’ã„ã‚‚ã®10å€‹ã€æ¢ã™ã€‚ã‚‚ã—ãã¯ã€Œä¸¸ã„ã‚‚ã®ã€ã€‚è¦–è¦šé‡ã¯â€œæ¢ã—ç‰©â€ãŒå¤§å¥½ãã€‚è¦‹ã¤ã‘ã‚‹ãŸã³ã«è„³ãŒå°ã•ãå–œã¶ã€‚ã“ã‚ŒãŒæ„å¤–ã¨åŠ¹ãã€‚",
                word: "ã€Œæ¢ã›ã€‚ä¸–ç•ŒãŒå¢—ãˆã‚‹ã€‚ã€"
            },
            { 
                name: "è´è¦šé‡", 
                kana: "å´é ­è‘‰", 
                role: "éŸ³ã®åˆ†æã¨ãƒªã‚ºãƒ ã€‚è„³ã®DJã€‚ä¼šè©±ã®æŠ‘æšã€ç’°å¢ƒéŸ³ã€éŸ³æ¥½ã§æ°—åˆ†ã‚’æ•´ãˆã‚‹ã€‚ã“ã“ãŒåƒãã¨ã€ãƒªã‚ºãƒ ã§é›†ä¸­ãŒä½œã‚Œã‚‹ã€‚",
                unlock: "æ‰‹æ‹å­ã‚’ä¸€å®šâ†’é€”ä¸­ã§ãƒ†ãƒ³ãƒå¤‰ãˆã‚‹ã€‚è¶³è¸ã¿ã‚‚è¶³ã™ã€‚ãƒªã‚ºãƒ ã‚’å¤‰ãˆã‚‹ã¨ã€è„³ãŒã€ŒãŠã£ã€ã£ã¦èµ·ãã‚‹ã€‚éŸ³ã¯è„³ã®ã‚¹ã‚¤ãƒƒãƒã€‚é™ã‹ã™ãã¦ã‚‚çœ ã‚‹ã‹ã‚‰ã€ã¡ã‚‡ã„åˆºæ¿€ãŒå‰ã€‚",
                word: "ã€Œãƒªã‚ºãƒ ã¯ã€è„³ã®ç›®è¦šã¾ã—ã€‚ã€"
            },
            { 
                name: "ã‚¦ã‚§ãƒ«ãƒ‹ãƒƒã‚±é‡", 
                kana: "", 
                role: "è¨€è‘‰ã®ç†è§£ã€‚ã€Œç›¸æ‰‹ãŒä½•è¨€ã£ã¦ã‚‹ã‹ã€ã‚’æ„å‘³ã«å¤‰ãˆã‚‹ç¿»è¨³æ©Ÿã€‚ã“ã“ãŒå¼·ã„ã¨ã€ä¼šè©±ãŒæ—©ã„ã€‚å¼±ã„ã¨ã€è¨€è‘‰ã¯èã“ãˆã‚‹ã®ã«æ„å‘³ãŒå…¥ã‚‰ãªã„ã€‚",
                unlock: "äººã®è©±ã‚’èã„ãŸã‚‰ã€é ­ã®ä¸­ã§ã€Œä¸€è¨€ã§è¨€ã†ã¨ï¼Ÿã€ã‚’ä½œã‚‹ã€‚è¦ç´„ã¯ç†è§£ã®å®Œæˆã€‚é•·è©±ã‚‚ã€ã¾ã¨ã‚ãŸç¬é–“ã«è‡ªåˆ†ã®ã‚‚ã®ã«ãªã‚‹ã€‚",
                word: "ã€Œã‚ã‹ã£ãŸï¼ä¸€è¨€ã§è¨€ãˆã‚‹ã€‚ã€"
            },
            { 
                name: "ãƒ–ãƒ­ãƒ¼ã‚«é‡", 
                kana: "", 
                role: "è©±ã™ãƒ»æ›¸ããƒ»è¨€è‘‰ã‚’å‡ºã™ã€‚è¨€èªã®å·¥å ´ã€‚ã“ã“ãŒå›ã‚‹ã¨ã€è€ƒãˆãŒå¤–ã«å‡ºã¦æ•´ç†ã•ã‚Œã‚‹ã€‚å›ã‚‰ãªã„ã¨ã€é ­ã®ä¸­ã§ã‚°ãƒ«ã‚°ãƒ«ã—ã¦ç–²ã‚Œã‚‹ã€‚",
                unlock: "15ç§’ãƒ¡ãƒ¢ã€‚ã†ã¾ã„æ–‡ç« ã„ã‚‰ãªã„ã€‚ç®‡æ¡æ›¸ãã§ã„ã„ã€‚è¨€è‘‰ã«ã™ã‚‹ã¨ã€è„³ãŒâ€œç‰‡ä»˜ã‘å§‹ã‚ã‚‹â€ã€‚è©±ã™ã®ã‚‚OKã€‚ã²ã¨ã‚Šå®Ÿæ³ã§ã‚‚åŠ¹æœã‚ã‚‹ï¼ˆå¤‰ãªäººã«è¦‹ãˆã‚‹ã‘ã©ã­ï¼‰ã€‚",
                word: "ã€Œå‡ºã›ã°ã€æ•´ã†ã€‚ã€"
            },
            { 
                name: "è¦–åºŠ", 
                kana: "ã—ã—ã‚‡ã†", 
                role: "æ„Ÿè¦šã®ä¸­ç¶™ã‚»ãƒ³ã‚¿ãƒ¼ã€‚æ³¨æ„ã®äº¤é€šæ•´ç†ã€‚æƒ…å ±ãŒå¤šã„ã¨æ¸‹æ»ã™ã‚‹ã€‚æ¸‹æ»ã™ã‚‹ã¨ã€ä½•ã‚‚å…¥ã‚‰ãªã„ã—ã€ä½•ã‚‚å‡ºãªã„ã€‚",
                unlock: "é€šçŸ¥ã‚’1æ™‚é–“åˆ‡ã‚‹ã€‚è¦–åºŠã¯â€œäº¤é€šé‡ã®åˆ¶é™â€ã«å¼±ã„ã‹ã‚‰ã€å¤–ã‹ã‚‰æ¸›ã‚‰ã—ã¦ã‚ã’ã‚‹ã¨ã‚¹ãƒƒã‚­ãƒªã™ã‚‹ã€‚éƒ¨å±‹ã‚’ç‰‡ä»˜ã‘ã‚‹ã¿ãŸã„ã«ã€æƒ…å ±ã‚‚ç‰‡ä»˜ã‘ã‚‹ã€‚",
                word: "ã€Œæƒ…å ±ã€å…¥ã‚Œã™ãã‚‹ãªã€‚è©°ã¾ã‚‹ã€‚ã€"
            },
            { 
                name: "è¦–åºŠä¸‹éƒ¨", 
                kana: "", 
                role: "ä½“æ¸©ãƒ»é£Ÿæ¬²ãƒ»ãƒ›ãƒ«ãƒ¢ãƒ³ãƒ»ç¡çœ ã€‚ä½“ã®è‡ªå‹•èª¿æ•´å®¤ã€‚ã“ã“ãŒæ•´ã†ã¨ã€æ°—åˆ†ã‚‚ã‚„ã‚‹æ°—ã‚‚å‹æ‰‹ã«æ•´ã†ã€‚é€†ã«å´©ã‚Œã‚‹ã¨ã€å…¨éƒ¨ãŒé›‘ã«ãªã‚‹ã€‚",
                unlock: "æœæ—¥ã‚’æµ´ã³ã¦æ°´ä¸€æ¯ã€‚å¯èƒ½ãªã‚‰åŒã˜æ™‚é–“ã«èµ·ãã‚‹ã€‚è¦–åºŠä¸‹éƒ¨ã¯â€œæ™‚è¨ˆâ€ãŒå‘½ã€‚æ™‚è¨ˆãŒåˆã†ã¨ã€ãƒ›ãƒ«ãƒ¢ãƒ³ã‚‚çœ æ°—ã‚‚å‘³æ–¹ã«ãªã‚‹ã€‚",
                word: "ã€Œæœæ—¥ã¨æ°´ã§ã€ä½“ã¯èµ·å‹•ã€‚ã€"
            },
            { 
                name: "å´åæ ¸", 
                kana: "ããã–ã‹ã", 
                role: "ã‚„ã‚‹æ°—ãƒ»å ±é…¬ãƒ»å¿«æ„Ÿã€‚ã€Œã‚‚ã†ä¸€å›ï¼ã€æ‹…å½“ã€‚ã“ã“ãŒå‹•ãã¨ã€ç¶šã‘ã‚‰ã‚Œã‚‹ã€‚å‹•ã‹ãªã„ã¨ã€ä½•ã‚„ã£ã¦ã‚‚é‡ã„ã€‚",
                unlock: "ä½œæ¥­ã®æœ€å¾Œã«â€œã”ã»ã†ã³1åˆ†â€ã‚’å›ºå®šã€‚éŸ³æ¥½ä¸€æ›²ã€ã‚¹ãƒˆãƒ¬ãƒƒãƒã€ã‚³ãƒ¼ãƒ’ãƒ¼ä¸€å£ã€‚è„³ã¯ã­ã€ãƒ‹ãƒ³ã‚¸ãƒ³ãŒã‚ã‚‹ã¨èµ°ã‚‹ã€‚é¦¬ã¿ãŸã„ã§ã‹ã‚ã„ã„ã€‚",
                word: "ã€Œãƒ‹ãƒ³ã‚¸ãƒ³ç”¨æ„ã—ã¨ã‘ã€‚ã€"
            },
            { 
                name: "é ­é ‚é€£åˆé‡", 
                kana: "", 
                role: "ç©ºé–“èªçŸ¥ã€æ³¨æ„ã®é…åˆ†ã€åŒæ™‚å‡¦ç†ã®æ•´ç†ä¿‚ã€‚ã“ã“ãŒå¼·ã„ã¨ã€å‘¨ã‚Šã‚’è¦‹ãªãŒã‚‰å‹•ã‘ã‚‹ã€‚å¼±ã„ã¨ã€ç›®ã®å‰ã®ã“ã¨ã ã‘ã§æ‰‹ä¸€æ¯ã«ãªã‚‹ã€‚",
                unlock: "è¶³è¸ã¿ã—ãªãŒã‚‰1ã€œ20æ•°ãˆã‚‹ã€‚ã§ããŸã‚‰æ‰‹ã‚’å·¦å³äº¤äº’ã«å‹•ã‹ã™ã€‚è„³ã«â€œäº¤é€šæ•´ç†ã®è¨“ç·´â€ã‚’éŠã³ã§å…¥ã‚Œã‚‹ã€‚ã‚„ã‚‹ã»ã©ç¾å®Ÿã®ãƒãƒ«ãƒã‚¿ã‚¹ã‚¯ãŒãƒ©ã‚¯ã«ãªã‚‹ã€‚",
                word: "ã€ŒåŒæ™‚ã¯ã€éŠã³ã§æ…£ã‚Œã‚ã€‚ã€"
            },
            { 
                name: "è„³æ¢", 
                kana: "ã®ã†ã‚Šã‚‡ã†", 
                role: "å·¦å³ã®è„³ã‚’ã¤ãªãé€£æºã‚±ãƒ¼ãƒ–ãƒ«ã€‚è«–ç†ã¨ç›´æ„Ÿã€è¨€è‘‰ã¨å‹•ãã€å³ã¨å·¦ã®å”åŠ›ãƒ—ãƒ¬ãƒ¼ã€‚ã“ã“ãŒå¼·ã„ã¨ã€å‹•ãã‚‚ç™ºæƒ³ã‚‚ã‚¹ãƒ ãƒ¼ã‚ºã€‚",
                unlock: "äº¤å·®é‹å‹•ï¼ˆå³æ‰‹ã§å·¦ã²ã–â†’åå¯¾ã‚‚ï¼‰ã‚’20å›ã€‚ã“ã‚Œã€åœ°å‘³ã ã‘ã©åŠ¹ãã€‚å·¦å³ãŒä»²è‰¯ããªã‚‹ã¨ã€è„³å†…ã®â€œé€£çµ¡ãƒŸã‚¹â€ãŒæ¸›ã‚‹ã®ã‚ˆã€‚",
                word: "ã€Œå·¦å³ã€ã‚±ãƒ³ã‚«ã•ã›ã‚‹ãªã€‚çµ„ã¾ã›ã‚ã€‚ã€"
            }
        ];

        // --- DICTIONARY ---
        const Dict = {
            ja: {
                menu_title: "ãŠå“æ›¸ã",
                btn_start: "ã“ã‚Œã«ã™ã‚‹", btn_back_menu: "ãŠå“æ›¸ãã«æˆ»ã‚‹",
                diff_title: "é›£æ˜“åº¦ã‚’é¸ã¶", diff_desc: "æ¾ç«¹æ¢…ã€ã©ã‚Œã«ã™ã‚‹ï¼Ÿ",
                lvl_easy: "æ¢… (åˆç´š)", lvl_easy_sub: "ã®ã‚“ã³ã‚Šã¨", lvl_normal: "ç«¹ (ä¸­ç´š)", lvl_normal_sub: "ãã“ãã“ã«", lvl_pro: "æ¾ (ä¸Šç´š)", lvl_pro_sub: "ã‚­ãƒ¬ã‚­ãƒ¬ã§", lvl_olympic: "å¯Œå£« (é¬¼)", lvl_olympic_sub: "ç„¡ç†ã‚²ãƒ¼",
                home_title: "æŒ‘æˆ¦çŠ¶", btn_game_start: "ã„ã–ã€å‹è² ï¼", btn_change_lvl: "é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹",
                overlay_rule: "éŠã³æ–¹", res_title: "UNLOCKå®Œäº†ï¼", res_score: "ã‚¹ã‚³ã‚¢", btn_close: "ã¨ã˜ã‚‹",
                mem_remember: "è¦šãˆã¦ï¼", mem_ask: "ã¯ã©ã“ï¼Ÿ", 
                share_text: "ã€æ–°æ˜¥UNLOCKã€‘ç§ã®ä»Šå¹´ã®ä¸»å½¹è„³ã¯ã€ŒTYPEã€ã§ã—ãŸï¼ #æ–°æ˜¥UNLOCK",
                // Games
                game_type_math_reflex: "ä¸åŠ è¨ˆç®—", game_desc_math_reflex: "ç­”ãˆã¯ã€Œä¸(å¶æ•°)ã€ã‹\nã€ŒåŠ(å¥‡æ•°)ã€ã‹ï¼ï¼Ÿ",
                game_type_memory_flash: "åˆå¤¢ãŠã¼ãˆ", game_desc_memory_flash: "ç¸èµ·ç‰©ã®å ´æ‰€ã‚’\nä¸€ç¬ã§è¨˜æ†¶ã›ã‚ˆï¼",
                game_type_karuta: "æ–°æ˜¥ ã‹ã‚‹ãŸ", game_desc_karuta: "èª­ã¿æœ­ã«åˆã†çµµæœ­ã‚’\nç´ æ—©ãå–ã‚Œï¼", 
                game_type_high_low: "ãŠå¹´ç‰ãƒã‚¤ãƒ­ãƒ¼", game_desc_high_low: "é‡‘é¡ãŒå¤§ãã„ã®ã¯\nã©ã£ã¡ã®è¢‹ï¼ï¼Ÿ",
                rule_tap_ans: "æ­£è§£ã®è‰²ã‚’é¸ã¹ï¼", rule_tap_dir: "å‘ã„ã¦ã„ã‚‹æ–¹ã¯ï¼Ÿ", rule_tap_calc: "ä¸ã‹åŠã‹ï¼Ÿ", rule_tap_mem: "å ´æ‰€ã‚’æ€ã„å‡ºã›ï¼", rule_tap_karuta: "æ­£ã—ã„æœ­ã‚’é¸ã¹ï¼", rule_tap_hl: "å¤§ãã„ã»ã†ã¯ï¼Ÿ", 
                txt_color: "è‰²", txt_read: "èª­ã¿", txt_win: "å‹ã£ã¦", txt_lose: "è² ã‘ã¦", txt_draw: "ã‚ã„ã“",
                txt_same: "ãã®ã¾ã¾", txt_rev: "åå¯¾", txt_r90: "å³90åº¦", txt_l90: "å·¦90åº¦",
                txt_even: "ä¸(å¶)", txt_odd: "åŠ(å¥‡)", txt_prime: "ç´ æ•°", txt_comp: "åˆæˆæ•°"
            },
            en: {
                menu_title: "Game Menu",
                btn_start: "Select", btn_back_menu: "Back to Menu",
                diff_title: "Select Level", diff_desc: "Choose your difficulty",
                lvl_easy: "Plum (Easy)", lvl_easy_sub: "Slow", lvl_normal: "Bamboo (Normal)", lvl_normal_sub: "Standard", lvl_pro: "Pine (Pro)", lvl_pro_sub: "Fast", lvl_olympic: "Fuji (God)", lvl_olympic_sub: "Dream",
                home_title: "Mission", btn_game_start: "Let's Go!", btn_change_lvl: "Change Level",
                overlay_rule: "How to Play", res_title: "Unlocked!", res_score: "Score", btn_close: "Close",
                mem_remember: "Memorize!", mem_ask: "Where was",
                share_text: "[New Year UNLOCK] Brain Type Diagnosis! ",
                game_type_math_reflex: "Odd or Even", game_desc_math_reflex: "Is the answer\nOdd or Even?",
                game_type_memory_flash: "First Dream", game_desc_memory_flash: "Memorize the\nlucky items!",
                game_type_karuta: "New Year Karuta", game_desc_karuta: "Pick the card\nthat matches the text!", 
                game_type_high_low: "Lucky Bag", game_desc_high_low: "Which bag has\nmore money?",
                rule_tap_ans: "Tap Correct Color!", rule_tap_dir: "Which direction?", rule_tap_calc: "Even or Odd?", rule_tap_mem: "Recall!", rule_tap_karuta: "Pick the Card!", rule_tap_hl: "Pick Higher!", 
                txt_color: "Color", txt_read: "Read", txt_win: "Win", txt_lose: "Lose", txt_draw: "Draw",
                txt_same: "Same", txt_rev: "Reverse", txt_r90: "Right 90", txt_l90: "Left 90",
                txt_even: "Even", txt_odd: "Odd", txt_prime: "Prime", txt_comp: "Composite"
            }
        };

        // --- USER DATA ---
        const UserData = {
            userId: 'guest',
            setUserId: function(id) { this.userId = id || 'guest'; },
            getKey: function() { return AppConfig.storageBaseKey + this.userId; },
            load: function() { const raw = localStorage.getItem(this.getKey()); return raw ? JSON.parse(raw) : { lastScore: 0 }; },
            save: function(data) { localStorage.setItem(this.getKey(), JSON.stringify(data)); },
            recordPlay: function(score) { const data = this.load(); data.lastScore = score; this.save(data); }
        };

        // --- APP CONTROLLER ---
        const app = {
            state: { lang: 'ja', currentView: 'language', score: 0, timeLeft: AppConfig.gameDuration, isPlaying: false, currentGameType: 'math_reflex', timerInterval: null, difficulty: 'normal', memoryAnswer: null, inputBlocked: false, currentBrainName: '' },

            init: function() {
                this.switchView('language');
            },

            setLanguage: function(lang) {
                this.state.lang = lang;
                this.updateTexts();
                this.switchView('menu');
            },
            
            selectGame: function(type) {
                this.state.currentGameType = type;
                this.updateTexts(); 
                this.switchView('lp');
            },
            
            toDifficulty: function() {
                this.switchView('difficulty');
            },

            updateTexts: function() {
                try {
                    const texts = Dict[this.state.lang];
                    const type = this.state.currentGameType;
                    
                    const lpTitle = document.getElementById('lp-game-title');
                    const lpDesc = document.getElementById('lp-game-desc');
                    const lpIcon = document.getElementById('lp-game-icon');
                    
                    if (lpTitle) lpTitle.innerText = texts[`game_type_${type}`];
                    if (lpDesc) lpDesc.innerText = texts[`game_desc_${type}`];
                    
                    const icons = { math_reflex: 'fa-abacus', memory_flash: 'fa-eye', karuta: 'fa-layer-group', high_low: 'fa-sack-dollar' };
                    if (lpIcon) lpIcon.className = `fa-solid ${icons[type] || 'fa-brain'} text-red-500 text-3xl`;

                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (texts[key]) el.innerText = texts[key];
                    });
                } catch(e) { console.error("Text update failed", e); }
            },

            setDifficulty: function(level) {
                this.state.difficulty = level;
                ['easy', 'normal', 'pro', 'olympic'].forEach(l => {
                    const btn = document.getElementById(`btn-${l}`);
                    if (btn) {
                        if(l === level) btn.classList.add('selected'); else btn.classList.remove('selected');
                    }
                });
            },

            enterHome: function() { this.setupHome(); this.switchView('home'); },
            
            setupHome: function() {
                const type = this.state.currentGameType;
                const texts = Dict[this.state.lang];
                let tKey = `game_type_${type}`;
                let dKey = `game_desc_${type}`;
                let rKey = 'rule_tap_ans';
                
                if(type === 'direction') rKey = 'rule_tap_dir';
                else if(type === 'math_reflex') rKey = 'rule_tap_calc';
                else if(type === 'memory_flash') rKey = 'rule_tap_mem';
                else if(type === 'karuta') rKey = 'rule_tap_karuta'; 
                else if(type === 'high_low') rKey = 'rule_tap_hl';

                document.getElementById('daily-title').innerText = texts[tKey] || type;
                document.getElementById('daily-desc').innerText = texts[dKey] || "";
                document.getElementById('game-rule-text').innerText = texts[rKey] || "";
                
                const diffLabels = { easy: {ja:"æ¢…",en:"Plum"}, normal: {ja:"ç«¹",en:"Bamboo"}, pro: {ja:"æ¾",en:"Pine"}, olympic: {ja:"å¯Œå£«",en:"Fuji"} };
                const badge = document.getElementById('level-badge');
                if (badge) {
                    badge.innerText = `LEVEL: ${diffLabels[this.state.difficulty][this.state.lang]}`;
                }
            },

            switchView: function(viewName) {
                const header = document.getElementById('app-header');
                const showHeader = ['menu', 'home', 'game', 'result', 'difficulty'].includes(viewName);
                if (header) {
                    if (showHeader) { header.classList.remove('hidden'); header.classList.add('flex'); } 
                    else { header.classList.add('hidden'); header.classList.remove('flex'); }
                }
                
                // Reset scroll
                const app = document.getElementById('app');
                if(app) app.scrollTop = 0;

                ['language', 'loading', 'menu', 'lp', 'difficulty', 'home', 'game', 'result'].forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if (el) {
                        if (v === viewName) { el.classList.remove('hidden'); if(v!=='loading') el.classList.add('flex'); } 
                        else { el.classList.add('hidden'); el.classList.remove('flex'); }
                    }
                });
                this.state.currentView = viewName;
            },

            startGame: function() {
                this.switchView('game');
                this.state.score = 0;
                this.state.timeLeft = AppConfig.gameDuration;
                document.getElementById('score-display').innerText = 0;
                
                const diffLabels = { easy: "æ¢…", normal: "ç«¹", pro: "æ¾", olympic: "å¯Œå£«" };
                document.getElementById('game-level-badge').innerText = `LEVEL: ${diffLabels[this.state.difficulty]}`;
                
                const overlay = document.getElementById('instruction-overlay');
                overlay.style.display = 'flex';
                setTimeout(() => { overlay.style.display = 'none'; this.state.isPlaying = true; this.startTimer(); this.nextRound(); }, 2000);
            },

            startTimer: function() {
                const timerBar = document.getElementById('timer-bar');
                timerBar.className = "h-full rounded-full transition-all duration-1000 ease-linear bg-red-500";
                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    const pct = (this.state.timeLeft / AppConfig.gameDuration) * 100;
                    timerBar.style.width = `${pct}%`;
                    if (this.state.timeLeft <= 0) this.endGame();
                }, 1000);
            },

            nextRound: function() {
                if (!this.state.isPlaying) return;
                const type = this.state.currentGameType;
                const stage = document.getElementById('stimulus-container');
                const controls = document.getElementById('controls-area');
                stage.innerHTML = ''; controls.innerHTML = '';
                
                if (type === 'memory_flash') {
                    controls.style.display = 'none';
                    this.renderMemoryFlash(stage);
                } else {
                    controls.style.display = 'grid';
                    if (type === 'math_reflex') this.renderMath(stage, controls);
                    else if (type === 'karuta') this.renderKaruta(stage, controls); 
                    else if (type === 'high_low') this.renderHighLow(stage, controls);
                }
            },

            // --- GAMES ---
            
            // 1. Memory Flash
            renderMemoryFlash: function(stage) {
                const texts = Dict[this.state.lang];
                this.state.inputBlocked = true;
                stage.innerHTML = `<div id="mem-question-area" class="w-full h-10 mb-1 flex items-center justify-center shrink-0"></div><div id="mem-grid" class="flex-1 grid grid-cols-2 gap-2 w-full p-1 max-w-[300px] min-h-0 overflow-visible"></div>`;
                const qArea = document.getElementById('mem-question-area');
                const grid = document.getElementById('mem-grid');
                
                let itemCount = 3; 
                if (this.state.difficulty === 'normal') itemCount = 4;
                if (this.state.difficulty === 'pro') itemCount = 5;
                if (this.state.difficulty === 'olympic') itemCount = 6;
                
                if (itemCount > 4) grid.classList.add('grid-cols-3');

                const icons = ['fa-mountain-sun', 'fa-feather-pointed', 'fa-carrot', 'fa-sun', 'fa-fan', 'fa-torii-gate', 'fa-om', 'fa-bottle-droplet', 'fa-shrimp', 'fa-fish'];
                const shuffledIcons = icons.sort(() => 0.5 - Math.random()).slice(0, itemCount);
                
                let slots = [];
                for(let i=0; i<itemCount; i++) {
                    const btn = document.createElement('div');
                    btn.className = "bg-white rounded-xl flex items-center justify-center text-3xl shadow-sm border border-slate-200 aspect-square";
                    btn.dataset.index = i;
                    grid.appendChild(btn);
                    slots.push(btn);
                }
                
                const targetPositions = [...Array(itemCount).keys()].sort(() => 0.5 - Math.random());

                targetPositions.forEach((posIndex, i) => {
                    const iconClass = shuffledIcons[i];
                    slots[posIndex].innerHTML = `<i class="fa-solid ${iconClass} text-red-600 animate-pop"></i>`;
                    slots[posIndex].dataset.icon = iconClass;
                    slots[posIndex].classList.add('border-red-200', 'bg-red-50');
                });
                
                qArea.innerHTML = `<span class="bg-red-100 text-red-600 px-4 py-1.5 rounded-full font-bold font-serif shadow-sm text-xs">${texts.mem_remember}</span>`;
                
                let showTime = 1000;
                if (this.state.difficulty === 'normal') showTime = 600;
                if (this.state.difficulty === 'pro') showTime = 400;
                if (this.state.difficulty === 'olympic') showTime = 200; 

                setTimeout(() => {
                    slots.forEach(slot => {
                        slot.innerHTML = ''; 
                        slot.classList.remove('bg-red-50', 'border-red-200');
                        slot.classList.add('cursor-pointer', 'active:scale-95', 'hover:bg-slate-50');
                        slot.onclick = () => { if (this.state.inputBlocked) return; this.handleAnswer(slot.dataset.index == this.state.memoryAnswer); };
                    });
                    const targetIdxInArray = Math.floor(Math.random() * itemCount);
                    this.state.memoryAnswer = targetPositions[targetIdxInArray];
                    const targetIcon = shuffledIcons[targetIdxInArray];
                    this.state.inputBlocked = false;
                    qArea.innerHTML = `<div class="flex items-center justify-center gap-2 animate-pop bg-white px-4 py-1.5 rounded-xl shadow-sm border border-slate-100"><i class="fa-solid ${targetIcon} text-2xl text-red-600"></i><span class="text-slate-700 font-bold font-serif text-sm">${texts.mem_ask}?</span></div>`;
                }, showTime);
            },

            // 4. Math
            renderMath: function(stage, controls) {
                const texts = Dict[this.state.lang];
                
                let n1, n2, n3, sum;
                let op1 = "+";
                let formulaStr = "";

                if (this.state.difficulty === 'easy') {
                    n1 = Math.floor(Math.random() * 9) + 1;
                    n2 = Math.floor(Math.random() * 9) + 1;
                    sum = n1 + n2;
                    formulaStr = `<span>${n1}</span><span class="text-red-400 text-2xl mx-1">+</span><span>${n2}</span>`;
                } else if (this.state.difficulty === 'normal') {
                     n1 = Math.floor(Math.random() * 20) + 1;
                     n2 = Math.floor(Math.random() * 20) + 1;
                     if (Math.random() > 0.5) { sum = n1 + n2; op1="+"; } else { sum = n1 - n2; op1="-"; }
                     formulaStr = `<span>${n1}</span><span class="text-red-400 text-2xl mx-1">${op1}</span><span>${n2}</span>`;
                } else {
                    n1 = Math.floor(Math.random() * 20) + 5;
                    n2 = Math.floor(Math.random() * 10) + 2;
                    n3 = Math.floor(Math.random() * 10) + 1;
                    let op2 = Math.random() > 0.5 ? "+" : "-";
                    op1 = Math.random() > 0.5 ? "+" : "-";
                    sum = n1;
                    if(op1 === "+") sum += n2; else sum -= n2;
                    if(op2 === "+") sum += n3; else sum -= n3;
                    formulaStr = `<span class="text-3xl">${n1}</span><span class="text-red-400 text-xl mx-1">${op1}</span><span class="text-3xl">${n2}</span><span class="text-red-400 text-xl mx-1">${op2}</span><span class="text-3xl">${n3}</span>`;
                }

                const isEven = Math.abs(sum) % 2 === 0;
                
                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="text-[10px] font-bold text-slate-400 mb-3 bg-slate-100 px-3 py-1 rounded-full">ä¸(å¶æ•°) ã‹ åŠ(å¥‡æ•°) ã‹ï¼Ÿ</div>
                        <div class="flex items-center justify-center text-4xl font-black text-slate-800 font-serif bg-white px-4 py-3 rounded-xl border-2 border-slate-100 shadow-sm w-full max-w-[260px]">
                            ${formulaStr}
                        </div>
                    </div>`;
                
                const mkBtn = (label, col, check) => {
                    const btn = document.createElement('button');
                    const diceIcon = check ? 'fa-dice-four' : 'fa-dice-five'; 
                    const bgClass = col === 'blue' ? 'bg-indigo-600' : 'bg-red-600';
                    btn.className = `${colorClass} text-white btn-newyear text-xl font-bold h-full py-2 flex flex-col items-center justify-center shadow-md font-serif border-2 border-white/20`;
                    btn.innerHTML = `<div><i class="fa-solid ${diceIcon} text-2xl mb-1 opacity-50"></i><br>${label}</div>`;
                    btn.onclick = () => this.handleAnswer(check);
                    controls.appendChild(btn);
                };
                mkBtn(texts.txt_even, 'blue', isEven);
                mkBtn(texts.txt_odd, 'red', !isEven);
                controls.classList.remove('grid-cols-3'); controls.classList.add('grid-cols-2');
            },
            
            // 5. Karuta
            renderKaruta: function(stage, controls) {
                const pairs = [
                    { t: {ja:'åˆæ—¥ã®å‡º', en:'Sunrise'}, i: 'fa-mountain-sun' },
                    { t: {ja:'åˆè©£', en:'Shrine'}, i: 'fa-torii-gate' },
                    { t: {ja:'ãŠå¹´ç‰', en:'Money'}, i: 'fa-envelope' },
                    { t: {ja:'æ›¸ãåˆã‚', en:'Writing'}, i: 'fa-pen-nib' },
                    { t: {ja:'é™¤å¤œã®é˜', en:'Bell'}, i: 'fa-bell' },
                    { t: {ja:'é›ªæ™¯è‰²', en:'Snow'}, i: 'fa-snowflake' },
                    { t: {ja:'ãŠé¤…', en:'Mochi'}, i: 'fa-circle' },
                    { t: {ja:'ã‚«ãƒ¡ãƒ©', en:'Camera'}, i: 'fa-camera' },
                    { t: {ja:'é–€æ¾', en:'Pine'}, i: 'fa-tree' },
                    { t: {ja:'ã‚³ãƒ', en:'Top'}, i: 'fa-dharmachakra' }
                ];
                
                let optionCount = 3;
                if(this.state.difficulty === 'normal') optionCount = 4;
                if(this.state.difficulty === 'pro' || this.state.difficulty === 'olympic') optionCount = 6;

                const shuffled = pairs.sort(() => 0.5 - Math.random());
                const currentSet = shuffled.slice(0, optionCount);
                const target = currentSet[Math.floor(Math.random() * optionCount)];

                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="inline-block bg-white border border-slate-200 px-4 py-1.5 rounded-full text-[10px] font-bold mb-3 text-slate-400">èª­ã¿æœ­</div>
                        <div class="card-washi px-5 py-3 text-2xl font-black font-serif text-slate-800 drop-shadow-sm border-4 border-red-500 animate-pop">
                            ${target.t[this.state.lang]}
                        </div>
                    </div>`;
                
                currentSet.forEach(item => {
                    const btn = document.createElement('button');
                    const textSize = optionCount >= 6 ? 'text-2xl' : 'text-4xl';
                    btn.className = `bg-white border-2 border-red-100 text-red-500 border-b-4 rounded-xl ${textSize} font-bold h-full flex items-center justify-center shadow-sm active:translate-y-1 active:border-b-2 active:bg-red-50 transition-all`;
                    btn.innerHTML = `<i class="fa-solid ${item.i}"></i>`;
                    btn.onclick = () => this.handleAnswer(item === target);
                    controls.appendChild(btn);
                });
                
                controls.classList.remove('grid-cols-2', 'grid-cols-3');
                if(optionCount >= 5) controls.classList.add('grid-cols-3');
                else controls.classList.add('grid-cols-2');
            },
            
            // 6. High Low
            renderHighLow: function(stage, controls) {
                let val1, val2, str1, str2;
                
                if (this.state.difficulty === 'easy') {
                    val1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    val2 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    while(val1 === val2) val2 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    str1 = `Â¥${val1}`; str2 = `Â¥${val2}`;
                } else {
                    const base = Math.floor(Math.random() * 50) * 100; 
                    const diff = (Math.floor(Math.random() * 10) + 1) * 100;
                    
                    const term1 = base + Math.floor(Math.random() * 2000);
                    const term2 = Math.floor(Math.random() * 1000);
                    val1 = term1 + term2;
                    str1 = `${term1} + ${term2}`;
                    
                    const term3 = base + Math.floor(Math.random() * 2000);
                    const term4 = Math.floor(Math.random() * 1000);
                    val2 = term3 - term4; 
                    str2 = `${term3} - ${term4}`;
                    
                    if(val1 === val2) val2 += 100;
                }
                
                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center w-full">
                        <div class="text-xs font-bold text-slate-400 mb-6 bg-slate-100 px-4 py-1.5 rounded-full">ä¸­èº«ãŒå¤šã„ã®ã¯ã©ã£ã¡ï¼Ÿ</div>
                        <div class="flex gap-2 items-center w-full justify-center px-1">
                            <div class="flex flex-col items-center flex-1 max-w-[48%]">
                                <div class="text-lg font-black text-slate-700 bg-white px-1 py-2 rounded-lg mb-2 border-2 border-slate-100 w-full text-center whitespace-nowrap tracking-tight shadow-sm overflow-hidden">${str1}</div>
                                <i class="fa-solid fa-envelope text-6xl text-red-500 drop-shadow-md"></i>
                            </div>
                            <div class="text-xl text-slate-300 font-black italic">VS</div>
                            <div class="flex flex-col items-center flex-1 max-w-[48%]">
                                <div class="text-lg font-black text-slate-700 bg-white px-1 py-2 rounded-lg mb-2 border-2 border-slate-100 w-full text-center whitespace-nowrap tracking-tight shadow-sm overflow-hidden">${str2}</div>
                                <i class="fa-solid fa-envelope text-6xl text-blue-500 drop-shadow-md"></i>
                            </div>
                        </div>
                    </div>`;
                
                const mkBtn = (val, color, isCorrect) => {
                    const btn = document.createElement('button');
                    const colorClass = color === 'red' ? 'bg-red-500' : 'bg-blue-500';
                    btn.className = `${colorClass} text-white btn-newyear text-xl font-bold h-full py-2 flex flex-col items-center justify-center shadow-md font-serif`;
                    btn.innerHTML = `ã“ã£ã¡ï¼`;
                    btn.onclick = () => this.handleAnswer(isCorrect);
                    controls.appendChild(btn);
                };
                mkBtn(val1, 'red', val1 >= val2); mkBtn(val2, 'blue', val2 >= val1);
                controls.classList.remove('grid-cols-3'); controls.classList.add('grid-cols-2');
            },

            handleAnswer: function(isCorrect) {
                if (!this.state.isPlaying) return;
                const stage = document.getElementById('game-stage');
                if (isCorrect) {
                    let points = 10;
                    if(this.state.difficulty === 'normal') points = 20;
                    if(this.state.difficulty === 'pro') points = 40;
                    if(this.state.difficulty === 'olympic') points = 80;
                    this.state.score += points;
                    stage.animate([{ transform: 'scale(1)', boxShadow: '0 0 0 rgba(239, 68, 68, 0)' }, { transform: 'scale(1.02)', boxShadow: '0 0 20px rgba(239, 68, 68, 0.3)' }, { transform: 'scale(1)', boxShadow: '0 0 0 rgba(239, 68, 68, 0)' }], { duration: 200 });
                } else {
                    let penalty = 0;
                    if(this.state.difficulty === 'pro') penalty = 20;
                    if(this.state.difficulty === 'olympic') penalty = 50; 
                    this.state.score = Math.max(0, this.state.score - penalty);
                    stage.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-5px) rotate(-1deg)' }, { transform: 'translateX(5px) rotate(1deg)' }, { transform: 'translateX(0)' }], { duration: 300 });
                }
                document.getElementById('score-display').innerText = this.state.score;
                const type = this.state.currentGameType;
                if(type === 'memory_flash') {
                    document.getElementById('mem-question-area').innerHTML = '';
                    setTimeout(() => this.nextRound(), 400);
                } else {
                    this.nextRound();
                }
            },
            
            endGame: function() {
                this.state.isPlaying = false; 
                clearInterval(this.state.timerInterval); 
                UserData.recordPlay(this.state.score);
                document.getElementById('final-score').innerText = this.state.score;
                
                // --- BRAIN TYPE SELECTION ---
                const brain = BrainData[Math.floor(Math.random() * BrainData.length)];
                const kanaPart = brain.kana ? `<span class="text-xs text-red-300 ml-1">(${brain.kana})</span>` : "";

                // Update UI with detailed text
                const area = document.getElementById('brain-result-area');
                area.innerHTML = `
                    <div class="flex flex-col items-center justify-center mb-4 border-b-2 border-red-100 pb-4">
                         <div class="text-sm font-bold text-red-500 bg-red-100 px-3 py-1 rounded-full mb-2">ä»Šå¹´ã®ä¸»å½¹è„³</div>
                         <div class="text-4xl font-black text-slate-800 font-serif text-center leading-tight mb-1">
                            ${brain.name}
                         </div>
                         ${kanaPart}
                    </div>
                    
                    <div class="text-left text-sm font-medium text-slate-700 space-y-4">
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <div class="font-bold text-red-600 text-base mb-1 font-serif">â— ã“ã®è„³ã¯ã©ã‚“ãªå½¹å‰²ï¼ˆæ©Ÿèƒ½ï¼‰ï¼Ÿ</div>
                            <div class="leading-relaxed text-sm font-medium">${brain.role}</div>
                        </div>
                        
                        <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                            <div class="font-bold text-red-600 text-base mb-1 font-serif">â— ã“ã®è„³ã®å¯èƒ½æ€§ã‚’è§£æ”¾ã™ã‚‹ã«ã¯ï¼ˆUNLOCKï¼‰</div>
                            <div class="leading-relaxed text-sm font-medium">${brain.unlock}</div>
                        </div>

                        <div class="pt-2 text-center">
                            <div class="text-xs font-bold text-slate-400 mb-1">â–¼ ã“ã‚Œã ã‘è¦šãˆã¦ãŠã„ã¦ï¼</div>
                            <div class="font-bold text-red-600 font-serif text-xl leading-tight drop-shadow-sm">
                                ${brain.word}
                            </div>
                        </div>
                    </div>
                `;
                
                this.state.currentBrainName = brain.name;
                this.switchView('result');
            },
            share: function(platform) {
                const texts = Dict[this.state.lang];
                const text = texts.share_text.replace("TYPE", this.state.currentBrainName) + this.state.score;
                const url = "https://liff.line.me/YOUR_LIFF_ID";
                if (platform === 'twitter') window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            }
        };

        window.onload = function() {
            const liffId = "LIFF_ID_PLACEHOLDER"; 
            if (typeof liff !== 'undefined') {
                liff.init({ liffId: liffId }).then(() => {
                    if (!liff.isLoggedIn() && liff.isInClient()) liff.login();
                    else liff.getProfile().then(p => { UserData.setUserId(p.userId); app.init(); }).catch(() => app.init());
                }).catch(() => app.init());
            } else { app.init(); }
        };
    </script>
</body>
</html>
