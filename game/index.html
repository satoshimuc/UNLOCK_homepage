<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ–°æ˜¥UNLOCK</title>
    
    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-ZT8CBC1JLV"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-XXXXXXXXXX"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', 'G-ZT8CBC1JLV');
    </script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Yuji+Syuku&family=Zen+Maru+Gothic:wght@500;700;900&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --color-red: #ef4444;
            --color-white: #ffffff;
            --color-gold: #d4af37;
        }
        body {
            font-family: "Zen Maru Gothic", "Hiragino Kaku Gothic ProN", sans-serif;
            background-color: #991b1b; /* èƒŒæ™¯ã‚’æ¿ƒã„èµ¤ï¼ˆæ¯›æ°ˆã®è‰²ï¼‰ã« */
            color: #334155;
            touch-action: manipulation; user-select: none; overflow-x: hidden;
        }
        h1, h2, h3, .font-serif {
            font-family: "Yuji Syuku", serif;
        }
        
        .bg-pattern-seigaiha {
            background-color: #fdf2f0;
            background-image: 
                radial-gradient(circle at 100% 150%, #fdf2f0 24%, #fee2e2 25%, #fee2e2 28%, #fdf2f0 29%, #fdf2f0 36%, #fee2e2 37%, #fee2e2 40%, transparent 40%, transparent),
                radial-gradient(circle at 0    150%, #fdf2f0 24%, #fee2e2 25%, #fee2e2 28%, #fdf2f0 29%, #fdf2f0 36%, #fee2e2 37%, #fee2e2 40%, transparent 40%, transparent),
                radial-gradient(circle at 50%  100%, #fee2e2 10%, #fdf2f0 11%, #fdf2f0 23%, #fee2e2 24%, #fee2e2 30%, #fdf2f0 31%, #fdf2f0 43%, #fee2e2 44%, #fee2e2 50%, #fdf2f0 51%, #fdf2f0 63%, #fee2e2 64%, #fee2e2 71%, transparent 71%, transparent),
                radial-gradient(circle at 100% 50%, #fee2e2 5%, #fdf2f0 6%, #fdf2f0 15%, #fee2e2 16%, #fee2e2 20%, #fdf2f0 21%, #fdf2f0 30%, #fee2e2 31%, #fee2e2 35%, #fdf2f0 36%, #fdf2f0 45%, #fee2e2 46%, #fee2e2 49%, transparent 50%, transparent),
                radial-gradient(circle at 0    50%, #fee2e2 5%, #fdf2f0 6%, #fdf2f0 15%, #fee2e2 16%, #fee2e2 20%, #fdf2f0 21%, #fdf2f0 30%, #fee2e2 31%, #fee2e2 35%, #fdf2f0 36%, #fdf2f0 45%, #fee2e2 46%, #fee2e2 49%, transparent 50%, transparent);
            background-size: 60px 30px;
        }

        /* Animations */
        @keyframes bounce-gentle { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-8px); } }
        .animate-bounce-gentle { animation: bounce-gentle 3s ease-in-out infinite; }
        
        @keyframes pop-in { 0% { transform: scale(0.8); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .animate-pop { animation: pop-in 0.4s cubic-bezier(0.34, 1.56, 0.64, 1) forwards; }
        
        @keyframes shake-omikuji { 0% { transform: rotate(0deg); } 25% { transform: rotate(10deg); } 50% { transform: rotate(0deg); } 75% { transform: rotate(-10deg); } 100% { transform: rotate(0deg); } }
        .animate-shake { animation: shake-omikuji 0.5s ease-in-out infinite; }

        @keyframes shine { 0% { background-position: 200% center; } 100% { background-position: -200% center; } }
        
        @keyframes spin-slow { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .animate-spin-slow { animation: spin-slow 10s linear infinite; }
        
        @keyframes confuse-shake { 0%, 100% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } }
        .animate-confuse { animation: confuse-shake 0.2s infinite; }

        /* UI Components */
        .btn-newyear {
            position: relative;
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 4px 0 #b91c1c, 0 8px 10px rgba(0,0,0,0.2);
            transition: all 0.1s;
            overflow: hidden;
        }
        .btn-newyear::after {
            content: ''; position: absolute; top: 0; left: 0; right: 0; bottom: 0;
            background: linear-gradient(45deg, transparent 40%, rgba(255,255,255,0.2) 50%, transparent 60%);
            background-size: 200% 200%;
            animation: shine 3s infinite linear;
            pointer-events: none;
        }
        .btn-newyear:active { transform: translateY(4px); box-shadow: 0 0 0 #b91c1c, inset 0 2px 5px rgba(0,0,0,0.2); }
        
        .card-washi {
            background-color: #fff;
            background-image: url("data:image/svg+xml,%3Csvg width='100' height='100' viewBox='0 0 100 100' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.5' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100' height='100' filter='url(%23noise)' opacity='0.08'/%3E%3C/svg%3E");
            border: 2px solid #e2e8f0;
            border-radius: 24px;
            box-shadow: 0 8px 0 rgba(0,0,0,0.05);
        }

        /* Level Buttons */
        .level-btn { transition: all 0.2s; position: relative; overflow: hidden; }
        .level-btn.selected { transform: scale(1.05); border-width: 2px; }
        .level-btn:not(.selected) { opacity: 0.7; transform: scale(0.95); filter: grayscale(0.5); }
        
        .level-ume { background: #fee2e2; border-color: #f87171; color: #b91c1c; }
        .level-take { background: #dcfce7; border-color: #4ade80; color: #15803d; }
        .level-matsu { background: #dbeafe; border-color: #60a5fa; color: #1d4ed8; }
        .level-fuji { 
            background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); 
            border-color: #fbbf24; color: #b45309; 
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
        }

        .mizuhiki-line {
            height: 4px; width: 100%;
            background: repeating-linear-gradient(90deg, #ef4444, #ef4444 10px, #ffffff 10px, #ffffff 20px, #d4af37 20px, #d4af37 30px);
        }
        
        .menu-item {
            background: white; border-radius: 16px; 
            border: 2px solid #fee2e2;
            box-shadow: 0 4px 0 #fecaca;
            transition: all 0.1s;
        }
        .menu-item:active { transform: translateY(4px); box-shadow: 0 0 0 transparent; }

        .writing-vertical { writing-mode: vertical-rl; text-orientation: upright; }
    </style>
</head>
<body class="h-screen w-full flex flex-col items-center justify-center relative text-slate-700 bg-pattern-seigaiha">

    <div id="app" class="w-full max-w-md h-full flex flex-col relative px-5 py-4 z-10 overflow-y-auto no-scrollbar">
        
        <!-- Header (Hidden on Language/Nengajo View) -->
        <header id="app-header" class="hidden justify-center items-center mb-4 animate-pop pt-2">
            <div class="flex items-center gap-2 cursor-pointer" onclick="app.switchView('menu')">
                <div class="w-8 h-8 bg-red-500 text-white rounded-full flex items-center justify-center font-serif font-bold text-xs border-2 border-white shadow-sm">ç¦</div>
                <span class="text-xl font-bold tracking-tight text-slate-800 font-serif">æ–°æ˜¥UNLOCK</span>
            </div>
        </header>

        <!-- [VIEW: LANGUAGE (NENGAJO)] -->
        <div id="view-language" class="flex flex-1 flex-col justify-center items-center animate-pop">
            
            <!-- Nengajo Card -->
            <div class="bg-white w-full max-w-[340px] aspect-[100/148] shadow-2xl rounded-sm p-6 relative flex flex-col items-center overflow-hidden border-l border-b border-r border-slate-300 transform rotate-1 transition-transform hover:rotate-0 duration-500">
                
                <!-- Postcard Decorations -->
                <div class="absolute top-3 left-3 text-[10px] font-bold text-slate-300 tracking-widest font-sans">POST CARD</div>
                <div class="absolute top-4 left-4 w-12 h-14 border border-red-200 rounded flex items-center justify-center opacity-40">
                    <span class="text-xs text-red-300 font-serif font-bold">å¹´è³€</span>
                </div>
                
                <!-- Main Content -->
                <div class="flex-1 flex flex-col items-center justify-center w-full z-10">
                    
                    <!-- Vertical Title -->
                    <h1 class="text-5xl font-black text-red-600 font-serif writing-vertical text-center leading-loose tracking-widest mb-4 drop-shadow-sm h-48">
                        è¬¹è³€æ–°å¹´
                    </h1>
                    
                    <!-- Icon -->
                    <div class="mb-6 relative">
                        <div class="w-20 h-20 bg-red-50 rounded-full flex items-center justify-center animate-bounce-gentle border border-red-100">
                            <i class="fa-solid fa-mountain-sun text-red-500 text-4xl"></i>
                        </div>
                        <div class="absolute -right-2 -top-2 text-yellow-500 animate-spin-slow text-xl"><i class="fa-solid fa-sun"></i></div>
                    </div>

                    <!-- Greeting -->
                    <p class="text-sm font-serif text-slate-600 text-center mb-6 leading-7 tracking-wider">
                        æ—§å¹´ä¸­ã¯è„³ã‚’ã”æ„›ç”¨ã„ãŸã ã<br>
                        èª ã«ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã—ãŸ<br>
                        æœ¬å¹´ã‚‚ä½•å’ã‚ˆã‚ã—ã<br>
                        ãŠé¡˜ã„ç”³ã—ä¸Šã’ã¾ã™
                    </p>

                    <!-- Buttons -->
                    <div class="w-full flex flex-col gap-3 px-4">
                        <button onclick="app.setLanguage('ja')" class="w-full bg-red-600 text-white font-serif font-bold py-3 rounded shadow-md border-b-4 border-red-800 active:translate-y-1 active:border-b-0 active:bg-red-700 transition-all flex items-center justify-center gap-2">
                            <span class="tracking-widest">æ—¥æœ¬èªã§å§‹ã‚ã‚‹</span>
                        </button>
                        <button onclick="app.setLanguage('en')" class="w-full text-slate-400 font-serif font-bold py-1 text-[10px] hover:text-slate-500 transition-colors">
                            English Mode
                        </button>
                    </div>
                </div>

                <!-- Card Texture/Overlay -->
                <div class="absolute top-0 left-0 w-full h-full bg-[url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiNjY2MiIG9wYWNpdHk9IjAuMSIvPgo8L3N2Zz4=')] opacity-30 pointer-events-none"></div>
            </div>
            
            <p class="mt-8 text-xs text-white/50 font-serif font-bold tracking-widest">å…ƒæ—¦ @ 2026 UNLOCK</p>
        </div>

        <!-- [VIEW: MENU] -->
        <div id="view-menu" class="hidden flex-1 flex-col justify-center items-center animate-pop w-full">
            <h2 class="text-2xl font-bold text-white mb-6 font-serif text-center drop-shadow-md" data-i18n="menu_title">ãŠå“æ›¸ã</h2>
            
            <div class="grid grid-cols-2 gap-3 w-full mb-4">
                <button onclick="app.selectGame('stroop')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-palette text-red-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_stroop">ç´…ç™½ æ–‡å­—åˆæˆ¦</span>
                </button>
                <button onclick="app.selectGame('direction')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-compass text-blue-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_direction">ç…å­èˆãƒŠãƒ“</span>
                </button>
                <button onclick="app.selectGame('math_reflex')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-abacus text-green-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_math_reflex">ä¸åŠ è¨ˆç®—</span>
                </button>
                <button onclick="app.selectGame('memory_flash')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-eye text-purple-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_memory_flash">åˆå¤¢ãŠã¼ãˆ</span>
                </button>
                <button onclick="app.selectGame('karuta')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-layer-group text-orange-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_karuta">æ–°æ˜¥ ã‹ã‚‹ãŸ</span>
                </button>
                <button onclick="app.selectGame('high_low')" class="menu-item p-4 flex flex-col items-center justify-center aspect-square">
                    <i class="fa-solid fa-sack-dollar text-yellow-500 text-3xl mb-2"></i>
                    <span class="font-bold text-sm text-slate-700 font-serif" data-i18n="game_type_high_low">ãŠå¹´ç‰ãƒã‚¤ãƒ­ãƒ¼</span>
                </button>
            </div>
            <p class="text-xs text-white/60 mt-2">â€»ä½•åº¦ã§ã‚‚éŠã¹ã¾ã™</p>
        </div>

        <!-- [VIEW: LP] -->
        <div id="view-lp" class="hidden flex-1 flex-col justify-center items-center animate-pop relative pb-8">
            <div class="text-center mb-6">
                <div class="mb-6 inline-block relative">
                    <div class="flex justify-center items-center relative h-32 w-32 mx-auto animate-bounce-gentle">
                        <div class="absolute inset-0 border-4 border-red-500 rounded-full opacity-20 bg-white/50"></div>
                        <div class="absolute inset-2 border-2 border-gold rounded-full opacity-40 border-dashed"></div>
                        <div class="absolute w-20 h-20 bg-white rounded-full shadow-lg z-20 flex items-center justify-center border-2 border-red-100">
                            <i id="lp-game-icon" class="fa-solid fa-dragon text-red-500 text-4xl"></i>
                        </div>
                        <i class="fa-regular fa-snowflake absolute top-0 right-0 text-white/50 text-2xl animate-spin-slow"></i>
                        <i class="fa-solid fa-fan absolute bottom-0 left-0 text-gold text-2xl"></i>
                    </div>
                </div>
                
                <div class="bg-white border-2 border-red-100 rounded-xl px-6 py-3 mt-4 mb-2 inline-block shadow-sm relative overflow-hidden">
                    <div class="mizuhiki-line absolute top-0 left-0 opacity-50"></div>
                    <p class="text-xs font-bold text-red-400 mb-1 tracking-widest">SELECTED GAME</p>
                    <p class="text-xl font-black text-slate-700 font-serif" id="lp-game-title">...</p>
                </div>
                <p id="lp-game-desc" class="text-white font-medium text-xs px-4 mt-2 leading-relaxed drop-shadow-md">...</p>
            </div>
            
            <button onclick="app.toDifficulty()" class="w-full btn-newyear font-bold text-xl py-5 shadow-lg shadow-red-900/50 group mb-3">
                <i class="fa-solid fa-play text-yellow-300 mr-2"></i> <span data-i18n="btn_start">ã“ã‚Œã«ã™ã‚‹</span>
            </button>
            <button onclick="app.switchView('menu')" class="text-white/70 text-sm font-bold underline">
                <span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span>
            </button>
        </div>

        <!-- [VIEW: DIFFICULTY] -->
        <div id="view-difficulty" class="hidden flex-1 flex-col justify-center items-center animate-pop">
            <h2 class="text-xl font-bold text-white mb-2 font-serif drop-shadow-md" data-i18n="diff_title">é›£æ˜“åº¦ã‚’é¸ã¶</h2>
            <p class="text-xs text-white/80 mb-6" data-i18n="diff_desc">æ¾ç«¹æ¢…ã€ã©ã‚Œã«ã™ã‚‹ï¼Ÿ</p>
            
            <div class="w-full grid grid-cols-2 gap-3 mb-6">
                <button onclick="app.setDifficulty('easy')" id="btn-easy" class="level-btn level-ume rounded-2xl p-3 flex flex-col items-center justify-center h-32 cursor-pointer shadow-sm">
                    <div class="text-3xl mb-2">ğŸŒ¸</div>
                    <span class="text-lg font-bold font-serif" data-i18n="lvl_easy">æ¢… (åˆç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_easy_sub">ã®ã‚“ã³ã‚Šã¨</span>
                </button>
                <button onclick="app.setDifficulty('normal')" id="btn-normal" class="level-btn level-take selected rounded-2xl p-3 flex flex-col items-center justify-center h-32 cursor-pointer shadow-sm">
                    <div class="text-3xl mb-2">ğŸ‹</div>
                    <span class="text-lg font-bold font-serif" data-i18n="lvl_normal">ç«¹ (ä¸­ç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_normal_sub">ãã“ãã“ã«</span>
                </button>
                <button onclick="app.setDifficulty('pro')" id="btn-pro" class="level-btn level-matsu rounded-2xl p-3 flex flex-col items-center justify-center h-32 cursor-pointer shadow-sm">
                    <div class="text-3xl mb-2">ğŸ</div>
                    <span class="text-lg font-bold font-serif" data-i18n="lvl_pro">æ¾ (ä¸Šç´š)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_pro_sub">ã‚­ãƒ¬ã‚­ãƒ¬ã§</span>
                </button>
                <button onclick="app.setDifficulty('olympic')" id="btn-olympic" class="level-btn level-fuji rounded-2xl p-3 flex flex-col items-center justify-center h-32 cursor-pointer shadow-sm">
                    <div class="text-3xl mb-2">ğŸ—»</div>
                    <span class="text-lg font-bold font-serif" data-i18n="lvl_olympic">å¯Œå£« (é¬¼)</span>
                    <span class="text-[10px] opacity-80" data-i18n="lvl_olympic_sub">ç„¡ç†ã‚²ãƒ¼</span>
                </button>
            </div>
            <button onclick="app.enterHome()" class="w-full bg-slate-800 text-white font-bold text-lg py-4 rounded-full shadow-lg active:scale-95 transition-transform">æ±ºå®š</button>
            <button onclick="app.switchView('menu')" class="mt-4 text-white/70 text-sm font-bold underline"><span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span></button>
        </div>

        <!-- [VIEW: HOME] -->
        <div id="view-home" class="hidden flex-1 flex-col justify-center items-center animate-pop">
            <div class="text-center mb-4">
                <h2 class="text-xl font-bold text-white font-serif drop-shadow-md" data-i18n="home_title">ä»Šæ—¥ã®æ›¸åˆã‚</h2>
                <div id="level-badge" class="inline-block bg-white text-red-500 text-[10px] font-bold px-3 py-1 rounded-full mt-1 shadow-sm">LEVEL</div>
            </div>

            <div class="card-washi w-full p-6 mb-6 relative overflow-hidden">
                <div class="relative z-10 text-center">
                    <span class="inline-block bg-red-100 text-red-600 text-[10px] font-bold px-2 py-1 rounded mb-3">TODAY'S MISSION</span>
                    <h3 id="daily-title" class="text-2xl font-black mb-2 text-slate-800 font-serif">Title</h3>
                    <p id="daily-desc" class="text-sm font-medium text-slate-600 mb-4 leading-relaxed">...</p>
                    <div class="flex justify-center gap-2">
                        <div class="bg-slate-50 px-4 py-1 rounded-full text-xs font-bold text-slate-500 border border-slate-200"><i class="fa-regular fa-clock mr-1"></i> 30ç§’ä¸€æœ¬å‹è² </div>
                    </div>
                </div>
            </div>

            <button onclick="app.startGame()" class="w-full btn-newyear text-xl py-5 shadow-lg shadow-red-900/50">
                <span data-i18n="btn_game_start">ã„ã–ã€å‹è² ï¼</span>
            </button>
            <button onclick="app.switchView('difficulty')" class="mt-6 text-white/70 text-xs font-bold underline" data-i18n="btn_change_lvl">é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹</button>
        </div>

        <!-- [VIEW: GAME] -->
        <div id="view-game" class="hidden flex-1 flex-col relative h-full">
            <!-- Timer -->
            <div class="w-full bg-white/20 rounded-full h-2 mb-4 overflow-hidden mt-2">
                <div id="timer-bar" class="bg-white h-full rounded-full transition-all duration-1000 ease-linear shadow-[0_0_10px_rgba(255,255,255,0.5)]" style="width: 100%"></div>
            </div>

            <div class="flex justify-between items-end mb-2 px-2 border-b-2 border-white/20 pb-2 text-white">
                <div class="flex flex-col">
                     <span class="text-[10px] font-bold opacity-80" id="game-level-badge">LEVEL</span>
                     <div class="text-xs font-bold bg-white/20 px-2 py-0.5 rounded-full border border-white/30">å¾—ç‚¹</div>
                </div>
                <div class="flex items-baseline gap-1">
                    <span id="score-display" class="text-4xl font-black font-serif drop-shadow-md">0</span>
                    <span class="text-xs font-bold opacity-80">ç‚¹</span>
                </div>
            </div>

            <div id="game-stage" class="flex-1 card-washi flex flex-col p-4 mb-4 relative transition-colors duration-300 items-center justify-center">
                <!-- Overlay Instruction -->
                <div id="instruction-overlay" class="absolute inset-0 bg-white/95 z-30 flex flex-col justify-center items-center text-center p-6 rounded-2xl">
                    <div class="text-5xl text-red-500 mb-4 animate-bounce"><i class="fa-solid fa-clover"></i></div>
                    <h3 class="text-2xl font-bold mb-2 text-slate-800 font-serif" data-i18n="overlay_rule">ãƒ«ãƒ¼ãƒ«</h3>
                    <p id="game-rule-text" class="font-medium text-slate-600 mb-6 text-lg">...</p>
                    <div class="text-4xl font-black text-red-500 animate-pulse font-serif">ã‚ˆãƒ¼ã„...</div>
                </div>
                <!-- Game Content -->
                <div id="stimulus-container" class="w-full h-full flex flex-col relative items-center justify-center"></div>
            </div>

            <div id="controls-area" class="grid grid-cols-2 gap-3 h-48 mb-2"></div>
        </div>

        <!-- [VIEW: RESULT (OMIKUJI)] -->
        <div id="view-result" class="hidden flex-1 flex-col justify-center items-center animate-pop">
            
            <div class="text-center mb-6">
                <h2 class="text-3xl font-bold text-white font-serif drop-shadow-md" data-i18n="res_title">ã‚ã£ã±ã‚Œï¼</h2>
                <p class="text-xs font-bold text-white/80 mt-1">ä»Šå¹´ã®é‹å‹¢ã¯â€¦ï¼Ÿ</p>
            </div>

            <div class="card-washi w-full py-6 px-6 text-center mb-4 bg-white relative border-4 border-double border-red-100 flex flex-col items-center">
                
                <!-- Omikuji Display Area -->
                <div id="omikuji-result-area" class="w-full text-left">
                    <!-- Dynamic Content -->
                </div>

                <div class="w-full h-px bg-slate-100 my-4"></div>

                <div class="flex items-end justify-center gap-2 mb-2">
                    <div class="text-xs font-bold text-slate-400 mb-1">SCORE</div>
                    <div id="final-score" class="text-5xl font-black text-slate-800 font-serif leading-none">0</div>
                </div>
            </div>

            <!-- LINE CTA Button -->
            <a href="https://line.me/" target="_blank" class="w-full bg-[#06C755] text-white font-bold py-4 rounded-2xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform mb-3 relative overflow-hidden group border border-green-400">
                <i class="fa-brands fa-line text-2xl"></i>
                <span class="text-lg">å…¬å¼ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’å‹ã ã¡è¿½åŠ </span>
                <i class="fa-solid fa-chevron-right ml-auto mr-2 opacity-50"></i>
            </a>

            <div class="flex w-full gap-2 mb-4">
                <button onclick="app.share('twitter')" class="flex-1 bg-black text-white font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform text-xs"><i class="fa-brands fa-x-twitter"></i> Xã§ã‚·ã‚§ã‚¢</button>
                <button onclick="app.enterHome()" class="flex-1 bg-slate-200 text-slate-600 font-bold py-3 rounded-xl shadow-lg flex items-center justify-center gap-2 active:scale-95 transition-transform text-xs">ã‚‚ã†ä¸€åº¦</button>
            </div>
            
            <button onclick="app.switchView('menu')" class="text-white/70 text-xs font-bold underline p-2"><span data-i18n="btn_back_menu">ãŠå“æ›¸ãã«æˆ»ã‚‹</span></button>
        </div>

        <!-- [VIEW: LOADING] -->
        <div id="view-loading" class="hidden flex-1 flex-col justify-center items-center">
            <div class="flex gap-3 mb-4">
                <div class="w-4 h-4 bg-red-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-4 h-4 bg-white border-2 border-slate-200 rounded-full animate-bounce" style="animation-delay: 0.1s"></div>
                <div class="w-4 h-4 bg-gold rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
            </div>
            <p class="text-xs font-bold text-white tracking-widest">LOADING...</p>
        </div>
    </div>

    <!-- SCRIPT -->
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const AppConfig = { gameDuration: 30, storageBaseKey: 'newyear_unlock_v8_' };
        
        // --- DATA: Omikuji (Positive Vibes) ---
        const OmikujiData = {
            daikichi: {
                title: "å¤§å‰",
                subtitle: "ï¼ˆã“ã®1å¹´ï¼‰",
                text: "ä»Šå¹´ã®ã‚ãªãŸã€è„³ã¿ããŒâ€œå‹æ‰‹ã«é€²åŒ–â€ã™ã‚‹å¹´ã€‚<br>æ–°ã—ã„ã“ã¨ã«æ‰‹ã‚’å‡ºã™ãŸã³ã€ä½“ã‚‚ã€ŒãŠã€ã„ã„ã­ã€ã£ã¦ã¤ã„ã¦ãã‚‹ã€‚<br>ã‚ºãƒ©ã—ã¦ã€éŠã‚“ã§ã€ç¬‘ã£ã¦ã‚‹ã†ã¡ã«ã€æ°—ã¥ã„ãŸã‚‰å¼·ããªã£ã¦ã‚‹ã€‚",
                word: "ä»Šå¹´ã®æˆé•·ã€ãŸã¶ã‚“è‡ªåˆ†ãŒã„ã¡ã°ã‚“ãƒ“ãƒƒã‚¯ãƒªã™ã‚‹ã€‚"
            },
            chukichi: {
                title: "ä¸­å‰",
                subtitle: "ï¼ˆã“ã®1å¹´ï¼‰",
                text: "ä¸­å‰ã£ã¦ã•ã€å®Ÿã¯â€œå®‰å®šã—ã¦å¼·ã„â€ã£ã¦æ„å‘³ã ã‹ã‚‰ã­ã€‚<br>ä»Šå¹´ã¯ã€è„³ã¨ä½“ãŒç„¡ç†ãªãå›ã‚‹ä»•çµ„ã¿ã‚’ä½œã‚Œã‚‹å¹´ã€‚<br>ã‚³ãƒ„ã¯ã€Œé ‘å¼µã‚‹ã€ã˜ã‚ƒãªãã¦ã€ŒåŒºåˆ‡ã‚‹ã€ã€‚ãã‚Œã ã‘ã§æ¯æ—¥ãŒä¸Šå‘ãã€‚",
                word: "ä»Šå¹´ã®ã‚ãªãŸã€ã¡ã‚ƒã‚“ã¨ç¶šãã€‚ã“ã‚Œæœ€å¼·ã€‚"
            },
            kichi: {
                title: "å‰",
                subtitle: "ï¼ˆã“ã®1å¹´ï¼‰",
                text: "å‰ã€ã„ã„ã‚ˆã€‚ã™ã”ãã„ã„ã€‚ä¼¸ã³ã‚‹å¹´ã®ã©çœŸã‚“ä¸­ã ã‚ˆã€‚<br>æ´¾æ‰‹ã˜ã‚ƒãªã„ã®ã«ã€ç©ã¿ä¸ŠãŒã£ã¦ã€æ°—ã¥ã„ãŸã‚‰ã€Œãˆã€ã“ã‚“ãªã§ãã‚‹ï¼Ÿã€ã£ã¦ãªã‚‹ã€‚<br>æ°´ãƒ»ç¡çœ ãƒ»æ•£æ­©ã®ä¸‰å…„å¼ŸãŒã€ä»Šå¹´ã®ã‚ãªãŸã‚’ã‚ã£ã¡ã‚ƒå®ˆã‚‹ã€‚",
                word: "åœ°å‘³ã«ç©ã‚“ã äººãŒã€ã„ã¡ã°ã‚“ãƒãƒƒãƒ”ãƒ¼ã«ãªã‚‹ä»•æ§˜ã€‚"
            },
            suekichi: {
                title: "æœ«å‰",
                subtitle: "ï¼ˆã“ã®1å¹´ï¼‰",
                text: "æœ«å‰ã¯ã­ã€â€œã“ã‚Œã‹ã‚‰ä¸ŠãŒã‚‹â€ã£ã¦å®£è¨€ã ã‹ã‚‰ã€‚æœ€é«˜ã˜ã‚ƒã‚“ã€‚<br>ä»Šå¹´ã¯ã€æ•´ãˆãŸåˆ†ã ã‘é‹ãŒè²¯é‡‘ã•ã‚Œã¦ã€å¾ŒåŠã§ãƒ‰ãƒ³ï¼ã£ã¦åŠ¹ã„ã¦ãã‚‹ã€‚<br>ä¼‘ã‚€ã®ã‚‚ã€ã»ãã™ã®ã‚‚ã€å…¨éƒ¨ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ã€‚",
                word: "ä»Šå¹´ã®å¾ŒåŠã€ã‚ãªãŸãŒä¸»äººå…¬ã«ãªã‚‹ã‚„ã¤ã€‚"
            }
        };

        // --- DICTIONARY ---
        const Dict = {
            ja: {
                menu_title: "ãŠå“æ›¸ã",
                btn_start: "ã“ã‚Œã«ã™ã‚‹", btn_back_menu: "ãŠå“æ›¸ãã«æˆ»ã‚‹",
                diff_title: "é›£æ˜“åº¦ã‚’é¸ã¶", diff_desc: "æ¾ç«¹æ¢…ã€ã©ã‚Œã«ã™ã‚‹ï¼Ÿ",
                lvl_easy: "æ¢… (åˆç´š)", lvl_easy_sub: "ã®ã‚“ã³ã‚Šã¨", lvl_normal: "ç«¹ (ä¸­ç´š)", lvl_normal_sub: "ãã“ãã“ã«", lvl_pro: "æ¾ (ä¸Šç´š)", lvl_pro_sub: "ã‚­ãƒ¬ã‚­ãƒ¬ã§", lvl_olympic: "å¯Œå£« (é¬¼)", lvl_olympic_sub: "ç„¡ç†ã‚²ãƒ¼",
                home_title: "æŒ‘æˆ¦çŠ¶", btn_game_start: "ã„ã–ã€å‹è² ï¼", btn_change_lvl: "é›£æ˜“åº¦ã‚’å¤‰ãˆã‚‹",
                overlay_rule: "éŠã³æ–¹", res_title: "ã‚ã£ã±ã‚Œï¼", res_score: "ã‚¹ã‚³ã‚¢", btn_close: "ã¨ã˜ã‚‹",
                mem_remember: "è¦šãˆã¦ï¼", mem_ask: "ã¯ã©ã“ï¼Ÿ", 
                share_text: "ã€æ–°æ˜¥UNLOCKã€‘ä»Šå¹´ã®ãŠã¿ãã˜çµæœï¼ã‚¹ã‚³ã‚¢: ",
                // Games
                game_type_stroop: "ç´…ç™½ æ–‡å­—åˆæˆ¦", game_desc_stroop: "æ–‡å­—ã®æ„å‘³ã§ã¯ãªãã€\nã€Œè‰²ã€ã‚’ç­”ãˆã‚ˆï¼",
                game_type_direction: "ç…å­èˆãƒŠãƒ“", game_desc_direction: "ç…å­èˆãŒå‘ã„ã¦ã„ã‚‹\næ–¹å‘ã‚’ç­”ãˆã‚ˆï¼",
                game_type_math_reflex: "ä¸åŠ è¨ˆç®—", game_desc_math_reflex: "ç­”ãˆã¯ã€Œä¸(å¶æ•°)ã€ã‹\nã€ŒåŠ(å¥‡æ•°)ã€ã‹ï¼ï¼Ÿ",
                game_type_memory_flash: "åˆå¤¢ãŠã¼ãˆ", game_desc_memory_flash: "ç¸èµ·ç‰©ã®å ´æ‰€ã‚’\nä¸€ç¬ã§è¨˜æ†¶ã›ã‚ˆï¼",
                game_type_karuta: "æ–°æ˜¥ ã‹ã‚‹ãŸ", game_desc_karuta: "èª­ã¿æœ­ã«åˆã†çµµæœ­ã‚’\nç´ æ—©ãå–ã‚Œï¼", 
                game_type_high_low: "ãŠå¹´ç‰ãƒã‚¤ãƒ­ãƒ¼", game_desc_high_low: "é‡‘é¡ãŒå¤§ãã„ã®ã¯\nã©ã£ã¡ã®è¢‹ï¼ï¼Ÿ",
                rule_tap_ans: "æ­£è§£ã®è‰²ã‚’é¸ã¹ï¼", rule_tap_dir: "å‘ã„ã¦ã„ã‚‹æ–¹ã¯ï¼Ÿ", rule_tap_calc: "ä¸ã‹åŠã‹ï¼Ÿ", rule_tap_mem: "å ´æ‰€ã‚’æ€ã„å‡ºã›ï¼", rule_tap_karuta: "æ­£ã—ã„æœ­ã‚’é¸ã¹ï¼", rule_tap_hl: "å¤§ãã„ã»ã†ã¯ï¼Ÿ", 
                txt_color: "è‰²", txt_read: "èª­ã¿", txt_win: "å‹ã£ã¦", txt_lose: "è² ã‘ã¦", txt_draw: "ã‚ã„ã“",
                txt_same: "ãã®ã¾ã¾", txt_rev: "åå¯¾", txt_r90: "å³90åº¦", txt_l90: "å·¦90åº¦",
                txt_even: "ä¸(å¶)", txt_odd: "åŠ(å¥‡)", txt_prime: "ç´ æ•°", txt_comp: "åˆæˆæ•°"
            },
            en: {
                menu_title: "Game Menu",
                btn_start: "Select", btn_back_menu: "Back to Menu",
                diff_title: "Select Level", diff_desc: "Choose your difficulty",
                lvl_easy: "Plum (Easy)", lvl_easy_sub: "Slow", lvl_normal: "Bamboo (Normal)", lvl_normal_sub: "Standard", lvl_pro: "Pine (Pro)", lvl_pro_sub: "Fast", lvl_olympic: "Fuji (God)", lvl_olympic_sub: "Dream",
                home_title: "Mission", btn_game_start: "Let's Go!", btn_change_lvl: "Change Level",
                overlay_rule: "How to Play", res_title: "Excellent!", res_score: "Score", btn_close: "Close",
                mem_remember: "Memorize!", mem_ask: "Where was",
                share_text: "[New Year UNLOCK] Omikuji Result: ",
                game_type_stroop: "Red & White", game_desc_stroop: "Tap the COLOR,\nnot the word!",
                game_type_direction: "Lion Dance", game_desc_direction: "Which way is\nthe Lion facing?",
                game_type_math_reflex: "Odd or Even", game_desc_math_reflex: "Is the answer\nOdd or Even?",
                game_type_memory_flash: "First Dream", game_desc_memory_flash: "Memorize the\nlucky items!",
                game_type_karuta: "New Year Karuta", game_desc_karuta: "Pick the card\nthat matches the text!", 
                game_type_high_low: "Lucky Bag", game_desc_high_low: "Which bag has\nmore money?",
                rule_tap_ans: "Tap Correct Color!", rule_tap_dir: "Which direction?", rule_tap_calc: "Even or Odd?", rule_tap_mem: "Recall!", rule_tap_karuta: "Pick the Card!", rule_tap_hl: "Pick Higher!", 
                txt_color: "Color", txt_read: "Read", txt_win: "Win", txt_lose: "Lose", txt_draw: "Draw",
                txt_same: "Same", txt_rev: "Reverse", txt_r90: "Right 90", txt_l90: "Left 90",
                txt_even: "Even", txt_odd: "Odd", txt_prime: "Prime", txt_comp: "Composite"
            }
        };

        // --- USER DATA ---
        const UserData = {
            userId: 'guest',
            setUserId: function(id) { this.userId = id || 'guest'; },
            getKey: function() { return AppConfig.storageBaseKey + this.userId; },
            load: function() { const raw = localStorage.getItem(this.getKey()); return raw ? JSON.parse(raw) : { lastScore: 0 }; },
            save: function(data) { localStorage.setItem(this.getKey(), JSON.stringify(data)); },
            recordPlay: function(score) { const data = this.load(); data.lastScore = score; this.save(data); }
        };

        // --- APP CONTROLLER ---
        const app = {
            state: { lang: 'ja', currentView: 'language', score: 0, timeLeft: AppConfig.gameDuration, isPlaying: false, currentGameType: 'stroop', timerInterval: null, difficulty: 'normal', memoryAnswer: null, inputBlocked: false, currentOmikujiTitle: '' },

            init: function() {
                this.switchView('language');
            },

            setLanguage: function(lang) {
                this.state.lang = lang;
                this.updateTexts();
                this.switchView('menu');
            },
            
            selectGame: function(type) {
                this.state.currentGameType = type;
                this.updateTexts(); 
                this.switchView('lp');
            },
            
            toDifficulty: function() {
                this.switchView('difficulty');
            },

            updateTexts: function() {
                try {
                    const texts = Dict[this.state.lang];
                    const type = this.state.currentGameType;
                    
                    const lpTitle = document.getElementById('lp-game-title');
                    const lpDesc = document.getElementById('lp-game-desc');
                    const lpIcon = document.getElementById('lp-game-icon');
                    
                    if (lpTitle) lpTitle.innerText = texts[`game_type_${type}`];
                    if (lpDesc) lpDesc.innerText = texts[`game_desc_${type}`];
                    
                    const icons = { stroop: 'fa-palette', direction: 'fa-compass', math_reflex: 'fa-abacus', memory_flash: 'fa-eye', karuta: 'fa-layer-group', high_low: 'fa-sack-dollar' };
                    if (lpIcon) lpIcon.className = `fa-solid ${icons[type] || 'fa-brain'} text-red-500 text-4xl`;

                    document.querySelectorAll('[data-i18n]').forEach(el => {
                        const key = el.getAttribute('data-i18n');
                        if (texts[key]) el.innerText = texts[key];
                    });
                } catch(e) { console.error("Text update failed", e); }
            },

            setDifficulty: function(level) {
                this.state.difficulty = level;
                ['easy', 'normal', 'pro', 'olympic'].forEach(l => {
                    const btn = document.getElementById(`btn-${l}`);
                    if (btn) {
                        if(l === level) btn.classList.add('selected'); else btn.classList.remove('selected');
                    }
                });
            },

            enterHome: function() { this.setupHome(); this.switchView('home'); },
            
            setupHome: function() {
                const type = this.state.currentGameType;
                const texts = Dict[this.state.lang];
                let tKey = `game_type_${type}`;
                let dKey = `game_desc_${type}`;
                let rKey = 'rule_tap_ans';
                
                if(type === 'direction') rKey = 'rule_tap_dir';
                else if(type === 'math_reflex') rKey = 'rule_tap_calc';
                else if(type === 'memory_flash') rKey = 'rule_tap_mem';
                else if(type === 'karuta') rKey = 'rule_tap_karuta'; 
                else if(type === 'high_low') rKey = 'rule_tap_hl';

                document.getElementById('daily-title').innerText = texts[tKey] || type;
                document.getElementById('daily-desc').innerText = texts[dKey] || "";
                document.getElementById('game-rule-text').innerText = texts[rKey] || "";
                
                const diffLabels = { easy: {ja:"æ¢…",en:"Plum"}, normal: {ja:"ç«¹",en:"Bamboo"}, pro: {ja:"æ¾",en:"Pine"}, olympic: {ja:"å¯Œå£«",en:"Fuji"} };
                const badge = document.getElementById('level-badge');
                if (badge) {
                    badge.innerText = `LEVEL: ${diffLabels[this.state.difficulty][this.state.lang]}`;
                }
            },

            switchView: function(viewName) {
                const header = document.getElementById('app-header');
                const showHeader = ['menu', 'home', 'game', 'result', 'difficulty'].includes(viewName);
                if (header) {
                    if (showHeader) { header.classList.remove('hidden'); header.classList.add('flex'); } 
                    else { header.classList.add('hidden'); header.classList.remove('flex'); }
                }
                
                ['language', 'loading', 'menu', 'lp', 'difficulty', 'home', 'game', 'result'].forEach(v => {
                    const el = document.getElementById(`view-${v}`);
                    if (el) {
                        if (v === viewName) { el.classList.remove('hidden'); if(v!=='loading') el.classList.add('flex'); } 
                        else { el.classList.add('hidden'); el.classList.remove('flex'); }
                    }
                });
                this.state.currentView = viewName;
            },

            startGame: function() {
                this.switchView('game');
                this.state.score = 0;
                this.state.timeLeft = AppConfig.gameDuration;
                document.getElementById('score-display').innerText = 0;
                
                const diffLabels = { easy: "æ¢…", normal: "ç«¹", pro: "æ¾", olympic: "å¯Œå£«" };
                document.getElementById('game-level-badge').innerText = `LEVEL: ${diffLabels[this.state.difficulty]}`;
                
                const overlay = document.getElementById('instruction-overlay');
                overlay.style.display = 'flex';
                setTimeout(() => { overlay.style.display = 'none'; this.state.isPlaying = true; this.startTimer(); this.nextRound(); }, 2000);
            },

            startTimer: function() {
                const timerBar = document.getElementById('timer-bar');
                timerBar.className = "h-full rounded-full transition-all duration-1000 ease-linear bg-red-500";
                this.state.timerInterval = setInterval(() => {
                    this.state.timeLeft--;
                    const pct = (this.state.timeLeft / AppConfig.gameDuration) * 100;
                    timerBar.style.width = `${pct}%`;
                    if (this.state.timeLeft <= 0) this.endGame();
                }, 1000);
            },

            nextRound: function() {
                if (!this.state.isPlaying) return;
                const type = this.state.currentGameType;
                const stage = document.getElementById('stimulus-container');
                const controls = document.getElementById('controls-area');
                stage.innerHTML = ''; controls.innerHTML = '';
                
                if (type === 'memory_flash') {
                    controls.style.display = 'none';
                    this.renderMemoryFlash(stage);
                } else {
                    controls.style.display = 'grid';
                    if (type === 'stroop') this.renderStroop(stage, controls);
                    else if (type === 'direction') this.renderDirection(stage, controls);
                    else if (type === 'math_reflex') this.renderMath(stage, controls);
                    else if (type === 'karuta') this.renderKaruta(stage, controls); 
                    else if (type === 'high_low') this.renderHighLow(stage, controls);
                }
            },

            // --- GAMES ---
            
            // 1. Memory Flash
            renderMemoryFlash: function(stage) {
                const texts = Dict[this.state.lang];
                this.state.inputBlocked = true;
                stage.innerHTML = `<div id="mem-question-area" class="w-full h-16 mb-2 flex items-center justify-center"></div><div id="mem-grid" class="flex-1 grid grid-cols-2 gap-2 w-full p-2 max-w-[320px]"></div>`;
                const qArea = document.getElementById('mem-question-area');
                const grid = document.getElementById('mem-grid');
                
                let itemCount = 3; 
                if (this.state.difficulty === 'normal') itemCount = 4;
                if (this.state.difficulty === 'pro') itemCount = 5;
                if (this.state.difficulty === 'olympic') itemCount = 6;
                
                if (itemCount > 4) grid.classList.add('grid-cols-3');

                const icons = ['fa-mountain-sun', 'fa-feather-pointed', 'fa-carrot', 'fa-sun', 'fa-fan', 'fa-torii-gate', 'fa-om', 'fa-bottle-droplet', 'fa-shrimp', 'fa-fish'];
                const shuffledIcons = icons.sort(() => 0.5 - Math.random()).slice(0, itemCount);
                
                let slots = [];
                for(let i=0; i<itemCount; i++) {
                    const btn = document.createElement('div');
                    btn.className = "bg-white rounded-xl flex items-center justify-center text-3xl shadow-sm border border-slate-200 aspect-square";
                    btn.dataset.index = i;
                    grid.appendChild(btn);
                    slots.push(btn);
                }
                
                const targetPositions = [...Array(itemCount).keys()].sort(() => 0.5 - Math.random());

                targetPositions.forEach((posIndex, i) => {
                    const iconClass = shuffledIcons[i];
                    slots[posIndex].innerHTML = `<i class="fa-solid ${iconClass} text-red-600 animate-pop"></i>`;
                    slots[posIndex].dataset.icon = iconClass;
                    slots[posIndex].classList.add('border-red-200', 'bg-red-50');
                });
                
                qArea.innerHTML = `<span class="bg-red-100 text-red-600 px-6 py-2 rounded-full font-bold font-serif shadow-sm text-sm">${texts.mem_remember}</span>`;
                
                let showTime = 1000;
                if (this.state.difficulty === 'normal') showTime = 600;
                if (this.state.difficulty === 'pro') showTime = 400;
                if (this.state.difficulty === 'olympic') showTime = 200; 

                setTimeout(() => {
                    slots.forEach(slot => {
                        slot.innerHTML = ''; 
                        slot.classList.remove('bg-red-50', 'border-red-200');
                        slot.classList.add('cursor-pointer', 'active:scale-95', 'hover:bg-slate-50');
                        slot.onclick = () => { if (this.state.inputBlocked) return; this.handleAnswer(slot.dataset.index == this.state.memoryAnswer); };
                    });
                    const targetIdxInArray = Math.floor(Math.random() * itemCount);
                    this.state.memoryAnswer = targetPositions[targetIdxInArray];
                    const targetIcon = shuffledIcons[targetIdxInArray];
                    this.state.inputBlocked = false;
                    qArea.innerHTML = `<div class="flex items-center justify-center gap-3 animate-pop bg-white px-4 py-2 rounded-xl shadow-sm border border-slate-100"><i class="fa-solid ${targetIcon} text-3xl text-red-600"></i><span class="text-slate-700 font-bold font-serif">${texts.mem_ask}?</span></div>`;
                }, showTime);
            },

            // 2. Stroop
            renderStroop: function(stage, controls) {
                const texts = Dict[this.state.lang];
                const allColors = [
                    { name: {ja:'ç´…', en:'RED'}, code: 'text-red-600', bg: 'bg-red-500', val: 'red' },
                    { name: {ja:'ç™½', en:'WHITE'}, code: 'text-slate-200', bg: 'bg-slate-500', val: 'white', border: 'border-slate-300' },
                    { name: {ja:'é‡‘', en:'GOLD'}, code: 'text-yellow-500', bg: 'bg-yellow-500', val: 'gold' },
                    { name: {ja:'é»’', en:'BLACK'}, code: 'text-slate-800', bg: 'bg-slate-800', val: 'black' }
                ];
                
                let pool = allColors; 
                const targetText = pool[Math.floor(Math.random() * pool.length)];
                let targetColor = pool[Math.floor(Math.random() * pool.length)];
                
                if (Math.random() > 0.2) {
                     const otherColors = pool.filter(c => c.val !== targetText.val);
                     if(otherColors.length > 0) targetColor = otherColors[Math.floor(Math.random() * otherColors.length)];
                }
                const correctAnswer = targetColor.val;
                
                let displayClass = targetColor.code;
                if(targetColor.val === 'white') displayClass = 'text-slate-300 text-shadow-sm';

                const animationClass = this.state.difficulty === 'olympic' || this.state.difficulty === 'pro' ? 'animate-confuse' : '';

                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="inline-block bg-slate-100 px-4 py-1 rounded-full text-xs font-bold text-slate-500 mb-6">æ–‡å­—ã®è‰²ã¯ï¼Ÿ</div>
                        <div class="text-7xl font-black font-serif ${displayClass} drop-shadow-md scale-110 ${animationClass}">${targetText.name[this.state.lang]}</div>
                    </div>`;
                
                [...pool].sort(() => Math.random() - 0.5).forEach(opt => {
                    const btn = document.createElement('button');
                    btn.className = `${opt.bg} text-white btn-newyear text-lg font-bold font-serif h-full flex items-center justify-center shadow-md border-b-4 border-black/20`;
                    btn.innerText = opt.name[this.state.lang];
                    btn.onclick = () => this.handleAnswer(opt.val === correctAnswer);
                    controls.appendChild(btn);
                });
                controls.classList.remove('grid-cols-2', 'grid-cols-3'); controls.classList.add('grid-cols-2');
            },

            // 3. Direction
            renderDirection: function(stage, controls) {
                const texts = Dict[this.state.lang];
                const dirs = ['up', 'down', 'left', 'right'];
                const icons = { up: 'fa-arrow-up', down: 'fa-arrow-down', left: 'fa-arrow-left', right: 'fa-arrow-right' };
                const actualDir = dirs[Math.floor(Math.random() * dirs.length)];
                let targetDir = actualDir;
                let instruction = texts.txt_same;
                
                let instructionColor = "text-slate-500"; 
                let isReverse = false;

                if (this.state.difficulty !== 'easy' && Math.random() > 0.4) {
                     instruction = texts.txt_rev;
                     targetDir = this.getOppositeDir(actualDir);
                     isReverse = true;
                }
                
                if (this.state.difficulty === 'olympic' || this.state.difficulty === 'pro') {
                    instructionColor = Math.random() > 0.5 ? "text-red-500" : "text-blue-500";
                } else {
                    instructionColor = isReverse ? "text-red-500" : "text-blue-500";
                }

                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="inline-block bg-white border border-slate-200 px-4 py-2 rounded-full text-lg font-bold font-serif mb-6 ${instructionColor} shadow-sm border-b-4">${instruction}</div>
                        <div class="relative">
                            <div class="absolute inset-0 bg-gold blur-xl opacity-30 rounded-full"></div>
                            <div class="text-8xl text-slate-700 drop-shadow-md relative z-10"><i class="fa-solid ${icons[actualDir]}"></i></div>
                        </div>
                    </div>`;
                
                dirs.forEach(d => {
                    const btn = document.createElement('button');
                    btn.className = `bg-white border-2 border-slate-200 text-slate-500 border-b-4 rounded-2xl text-4xl font-bold h-full flex items-center justify-center shadow-sm active:translate-y-1 active:border-b-2 active:bg-red-50 transition-all`;
                    btn.innerHTML = `<i class="fa-solid ${icons[d]}"></i>`;
                    btn.onclick = () => this.handleAnswer(d === targetDir);
                    controls.appendChild(btn);
                });
                controls.classList.remove('grid-cols-3'); controls.classList.add('grid-cols-2');
            },
            getOppositeDir: function(d) { if(d==='up') return 'down'; if(d==='down') return 'up'; if(d==='left') return 'right'; return 'left'; },

            // 4. Math
            renderMath: function(stage, controls) {
                const texts = Dict[this.state.lang];
                
                let n1, n2, n3, sum;
                let op1 = "+";
                let formulaStr = "";

                if (this.state.difficulty === 'easy') {
                    n1 = Math.floor(Math.random() * 9) + 1;
                    n2 = Math.floor(Math.random() * 9) + 1;
                    sum = n1 + n2;
                    formulaStr = `<span>${n1}</span><span class="text-red-400 text-3xl mx-1">+</span><span>${n2}</span>`;
                } else if (this.state.difficulty === 'normal') {
                     n1 = Math.floor(Math.random() * 20) + 1;
                     n2 = Math.floor(Math.random() * 20) + 1;
                     if (Math.random() > 0.5) { sum = n1 + n2; op1="+"; } else { sum = n1 - n2; op1="-"; }
                     formulaStr = `<span>${n1}</span><span class="text-red-400 text-3xl mx-1">${op1}</span><span>${n2}</span>`;
                } else {
                    n1 = Math.floor(Math.random() * 20) + 5;
                    n2 = Math.floor(Math.random() * 10) + 2;
                    n3 = Math.floor(Math.random() * 10) + 1;
                    let op2 = Math.random() > 0.5 ? "+" : "-";
                    op1 = Math.random() > 0.5 ? "+" : "-";
                    sum = n1;
                    if(op1 === "+") sum += n2; else sum -= n2;
                    if(op2 === "+") sum += n3; else sum -= n3;
                    formulaStr = `<span class="text-4xl">${n1}</span><span class="text-red-400 text-2xl mx-1">${op1}</span><span class="text-4xl">${n2}</span><span class="text-red-400 text-2xl mx-1">${op2}</span><span class="text-4xl">${n3}</span>`;
                }

                const isEven = Math.abs(sum) % 2 === 0;
                
                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="text-xs font-bold text-slate-400 mb-4 bg-slate-100 px-3 py-1 rounded-full">ä¸(å¶æ•°) ã‹ åŠ(å¥‡æ•°) ã‹ï¼Ÿ</div>
                        <div class="flex items-center justify-center text-5xl font-black text-slate-800 font-serif bg-white px-6 py-4 rounded-xl border-2 border-slate-100 shadow-sm w-full">
                            ${formulaStr}
                        </div>
                    </div>`;
                
                const mkBtn = (label, col, check) => {
                    const btn = document.createElement('button');
                    const diceIcon = check ? 'fa-dice-four' : 'fa-dice-five'; 
                    const bgClass = col === 'blue' ? 'bg-indigo-600' : 'bg-red-600';
                    btn.className = `${bgClass} text-white btn-newyear text-2xl font-bold h-full py-4 flex flex-col items-center justify-center shadow-md font-serif border-2 border-white/20`;
                    btn.innerHTML = `<div><i class="fa-solid ${diceIcon} text-3xl mb-1 opacity-50"></i><br>${label}</div>`;
                    btn.onclick = () => this.handleAnswer(check);
                    controls.appendChild(btn);
                };
                mkBtn(texts.txt_even, 'blue', isEven);
                mkBtn(texts.txt_odd, 'red', !isEven);
                controls.classList.remove('grid-cols-3'); controls.classList.add('grid-cols-2');
            },
            
            // 5. Karuta
            renderKaruta: function(stage, controls) {
                const pairs = [
                    { t: {ja:'åˆæ—¥ã®å‡º', en:'Sunrise'}, i: 'fa-mountain-sun' },
                    { t: {ja:'åˆè©£', en:'Shrine'}, i: 'fa-torii-gate' },
                    { t: {ja:'ãŠå¹´ç‰', en:'Money'}, i: 'fa-envelope' },
                    { t: {ja:'æ›¸ãåˆã‚', en:'Writing'}, i: 'fa-pen-nib' },
                    { t: {ja:'é™¤å¤œã®é˜', en:'Bell'}, i: 'fa-bell' },
                    { t: {ja:'é›ªæ™¯è‰²', en:'Snow'}, i: 'fa-snowflake' },
                    { t: {ja:'ãŠé¤…', en:'Mochi'}, i: 'fa-circle' },
                    { t: {ja:'ã‚«ãƒ¡ãƒ©', en:'Camera'}, i: 'fa-camera' },
                    { t: {ja:'é–€æ¾', en:'Pine'}, i: 'fa-tree' },
                    { t: {ja:'ã‚³ãƒ', en:'Top'}, i: 'fa-dharmachakra' }
                ];
                
                let optionCount = 3;
                if(this.state.difficulty === 'normal') optionCount = 4;
                if(this.state.difficulty === 'pro' || this.state.difficulty === 'olympic') optionCount = 6;

                const shuffled = pairs.sort(() => 0.5 - Math.random());
                const currentSet = shuffled.slice(0, optionCount);
                const target = currentSet[Math.floor(Math.random() * optionCount)];

                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="inline-block bg-white border border-slate-200 px-6 py-2 rounded-full text-xs font-bold mb-4 text-slate-400">èª­ã¿æœ­</div>
                        <div class="card-washi px-6 py-4 text-3xl font-black font-serif text-slate-800 drop-shadow-sm border-4 border-red-500 animate-pop">
                            ${target.t[this.state.lang]}
                        </div>
                    </div>`;
                
                currentSet.forEach(item => {
                    const btn = document.createElement('button');
                    const textSize = optionCount >= 6 ? 'text-3xl' : 'text-5xl';
                    btn.className = `bg-white border-2 border-red-100 text-red-500 border-b-4 rounded-xl ${textSize} font-bold h-full flex items-center justify-center shadow-sm active:translate-y-1 active:border-b-2 active:bg-red-50 transition-all`;
                    btn.innerHTML = `<i class="fa-solid ${item.i}"></i>`;
                    btn.onclick = () => this.handleAnswer(item === target);
                    controls.appendChild(btn);
                });
                
                controls.classList.remove('grid-cols-2', 'grid-cols-3');
                if(optionCount >= 5) controls.classList.add('grid-cols-3');
                else controls.classList.add('grid-cols-2');
            },
            
            // 6. High Low
            renderHighLow: function(stage, controls) {
                let val1, val2, str1, str2;
                
                if (this.state.difficulty === 'easy') {
                    val1 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    val2 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    while(val1 === val2) val2 = (Math.floor(Math.random() * 10) + 1) * 1000;
                    str1 = `Â¥${val1}`; str2 = `Â¥${val2}`;
                } else {
                    const base = Math.floor(Math.random() * 50) * 100; 
                    const diff = (Math.floor(Math.random() * 10) + 1) * 100;
                    
                    const term1 = base + Math.floor(Math.random() * 2000);
                    const term2 = Math.floor(Math.random() * 1000);
                    val1 = term1 + term2;
                    str1 = `${term1} + ${term2}`;
                    
                    const term3 = base + Math.floor(Math.random() * 2000);
                    const term4 = Math.floor(Math.random() * 1000);
                    val2 = term3 - term4; 
                    str2 = `${term3} - ${term4}`;
                    
                    if(val1 === val2) val2 += 100;
                }
                
                stage.innerHTML = `
                    <div class="h-full flex flex-col justify-center items-center">
                        <div class="text-xs font-bold text-slate-400 mb-6 bg-slate-100 px-3 py-1 rounded-full">ä¸­èº«ãŒå¤šã„ã®ã¯ã©ã£ã¡ï¼Ÿ</div>
                        <div class="flex gap-2 items-center w-full justify-center px-1">
                            <div class="flex flex-col items-center flex-1">
                                <div class="text-base font-black text-slate-700 bg-white px-2 py-1 rounded mb-2 border border-slate-200 w-full text-center">${str1}</div>
                                <i class="fa-solid fa-envelope text-6xl text-red-500 drop-shadow-md"></i>
                            </div>
                            <div class="text-lg text-slate-400 font-bold italic">VS</div>
                            <div class="flex flex-col items-center flex-1">
                                <div class="text-base font-black text-slate-700 bg-white px-2 py-1 rounded mb-2 border border-slate-200 w-full text-center">${str2}</div>
                                <i class="fa-solid fa-envelope text-6xl text-blue-500 drop-shadow-md"></i>
                            </div>
                        </div>
                    </div>`;
                
                const mkBtn = (val, color, isCorrect) => {
                    const btn = document.createElement('button');
                    const colorClass = color === 'red' ? 'bg-red-500' : 'bg-blue-500';
                    btn.className = `${colorClass} text-white btn-newyear text-xl font-bold h-full py-4 flex flex-col items-center justify-center shadow-md font-serif`;
                    btn.innerHTML = `ã“ã£ã¡ï¼`;
                    btn.onclick = () => this.handleAnswer(isCorrect);
                    controls.appendChild(btn);
                };
                mkBtn(val1, 'red', val1 >= val2); mkBtn(val2, 'blue', val2 >= val1);
                controls.classList.remove('grid-cols-3'); controls.classList.add('grid-cols-2');
            },

            handleAnswer: function(isCorrect) {
                if (!this.state.isPlaying) return;
                const stage = document.getElementById('game-stage');
                if (isCorrect) {
                    let points = 10;
                    if(this.state.difficulty === 'normal') points = 20;
                    if(this.state.difficulty === 'pro') points = 40;
                    if(this.state.difficulty === 'olympic') points = 80;
                    this.state.score += points;
                    stage.animate([{ transform: 'scale(1)', boxShadow: '0 0 0 rgba(239, 68, 68, 0)' }, { transform: 'scale(1.02)', boxShadow: '0 0 20px rgba(239, 68, 68, 0.3)' }, { transform: 'scale(1)', boxShadow: '0 0 0 rgba(239, 68, 68, 0)' }], { duration: 200 });
                } else {
                    let penalty = 0;
                    if(this.state.difficulty === 'pro') penalty = 20;
                    if(this.state.difficulty === 'olympic') penalty = 50; 
                    this.state.score = Math.max(0, this.state.score - penalty);
                    stage.animate([{ transform: 'translateX(0)' }, { transform: 'translateX(-5px) rotate(-1deg)' }, { transform: 'translateX(5px) rotate(1deg)' }, { transform: 'translateX(0)' }], { duration: 300 });
                }
                document.getElementById('score-display').innerText = this.state.score;
                const type = this.state.currentGameType;
                if(type === 'memory_flash') {
                    document.getElementById('mem-question-area').innerHTML = '';
                    setTimeout(() => this.nextRound(), 400);
                } else {
                    this.nextRound();
                }
            },
            
            endGame: function() {
                this.state.isPlaying = false; 
                clearInterval(this.state.timerInterval); 
                UserData.recordPlay(this.state.score);
                document.getElementById('final-score').innerText = this.state.score;
                
                // --- OMIKUJI LOGIC ---
                let resultData = OmikujiData.suekichi; // Default
                if (this.state.score >= 200) resultData = OmikujiData.kichi;
                if (this.state.score >= 400) resultData = OmikujiData.chukichi;
                if (this.state.score >= 600) resultData = OmikujiData.daikichi;

                // Update UI with detailed text
                const area = document.getElementById('omikuji-result-area');
                area.innerHTML = `
                    <div class="flex items-center justify-center mb-4">
                         <div class="text-6xl font-black text-red-600 font-serif drop-shadow-md animate-pop">${resultData.title} <span class="text-3xl">âœ¨</span></div>
                    </div>
                    <div class="text-center text-xs font-bold text-slate-400 mb-3">${resultData.subtitle}</div>
                    <div class="text-left text-sm font-medium text-slate-700 bg-red-50 p-4 rounded-xl border border-red-100 leading-relaxed mb-3">
                        ${resultData.text}
                    </div>
                    <div class="text-center font-serif text-base text-red-600 font-bold border-t border-red-100 pt-3">
                        ã²ã¨ã“ã¨ï¼š ${resultData.word}
                    </div>
                `;
                
                this.state.currentOmikujiTitle = resultData.title;
                this.switchView('result');
            },
            share: function(platform) {
                const texts = Dict[this.state.lang];
                const text = `${texts.share_text} ${this.state.score} (${this.state.currentOmikujiTitle}) #æ–°æ˜¥UNLOCK`;
                const url = "https://liff.line.me/YOUR_LIFF_ID";
                if (platform === 'twitter') window.open(`https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`, '_blank');
            }
        };

        window.onload = function() {
            const liffId = "LIFF_ID_PLACEHOLDER"; 
            if (typeof liff !== 'undefined') {
                liff.init({ liffId: liffId }).then(() => {
                    if (!liff.isLoggedIn() && liff.isInClient()) liff.login();
                    else liff.getProfile().then(p => { UserData.setUserId(p.userId); app.init(); }).catch(() => app.init());
                }).catch(() => app.init());
            } else { app.init(); }
        };
    </script>
</body>
</html>
